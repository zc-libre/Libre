INSERT INTO public.blog_article (id, cover, article_name, summary, content, status, top, featured, gmt_create,
                                 gmt_modified, gmt_create_name, gmt_modified_name, is_deleted, category_id,
                                 enable_comment, article_type)
VALUES (1, '1702050892248-202201cthxrxhggtg.jpg', 'æµ‹è¯•æ–‡ç« ', 'sfsfsf',
        '![202201cthxrxhggtg.jpg](http://127.0.0.1:9876/file/1702057235527-202201cthxrxhggtg.jpg)', 1, 1, 1,
        '2023-12-08 23:54:56.626668', '2023-12-09 01:40:55.952721', 'admin', 'admin', 0, 1718181774380523521, 1, 1);
INSERT INTO public.blog_article (id, cover, article_name, summary, content, status, top, featured, gmt_create,
                                 gmt_modified, gmt_create_name, gmt_modified_name, is_deleted, category_id,
                                 enable_comment, article_type)
VALUES (3, 'https://source.unsplash.com/63ZraxGFJV4/1200x628', 'whoami', '123', e'<img class="img-center" src="https://res.cloudinary.com/tridiamond/image/upload/v1625037705/ObsidianestLogo-hex_hecqbw.png" style="height: 200px; width: 200px; border-radius: 50%; margin-bottom: 15px" />

<style>
  .language-code span {
    padding: 0.2em 0.4em;
    margin: 0;
    font-size: 85%;
    white-space: break-spaces;
    background: var(--banner-cover);
    border-radius: 6px;
  }
  .language-code span img {
    transform: scale(0.85);
    cursor: default !important;
  }
  .language-code span:hover img {
    transform: scale(1.25);
    opacity: 1;
  }
  .img-center {margin: 0 auto;}
  .dark-obsidian .article .main .content {
    padding: 0 6rem;
  }
  @media screen and (max-width: 1200px) {
    .dark-obsidian .article .main .content {
      padding: 0 0.5rem;
    }
  }
</style>

<h3 id="Who-am-I"><a href="#Who-am-I" class="headerlink" title="Who am I"></a><code>Who am I</code></h3><p>Gâ€™day, mate! ğŸ‘‹ I am <b style="color: #0ed2f7"><strong>Benny Guo</strong></b> a professional web developer, who â¤ï¸ to develop open source themes and applications. I have being a programmer for over 8 years, and have extensive experiences in both frontend and backend development.</p>
<p>Hello!ğŸ‘‹ æˆ‘æ˜¯<b style="color: #0ed2f7"><strong>ä¸‰é’»</strong></b>ï¼Œä¸€ä¸ªä¸“ä¸šçš„ web å¼€å‘è€…ï¼Œç©ºä½™æ—¶é—´çƒ­çˆ± â¤ï¸ å¼€å‘å¼€æºä¸»é¢˜å’Œåº”ç”¨ã€‚åœ¨å‰ç«¯å’Œåç«¯å¼€å‘æ–¹é¢å…±æœ‰è¶…è¿‡ 8 å¹´çš„ä¸°å¯Œå¼€å‘ç»éªŒã€‚</p>
<p>è¿½æ±‚æè‡´, è¿½æ±‚å®Œç¾, å–œæ¬¢ä¸€ä¸ªé«˜æ•ˆ, ä¼˜é›…, é«˜å‡èšåŠ›çš„å›¢é˜Ÿ,<br>ç«‹å¿—äºæ‰“é€ æœ€ä¼˜ç§€çš„äº§å“, æˆä¸ºä¸€åæ—¢ä¼˜é›…è€Œæœ‰æ·±åº¦çš„æŠ€æœ¯äººæ‰ã€‚</p>
<h3 id="âœ¨-Skills-Tools-æŠ€èƒ½-å·¥å…·"><a href="#âœ¨-Skills-Tools-æŠ€èƒ½-å·¥å…·" class="headerlink" title="âœ¨ Skills &amp; Tools - æŠ€èƒ½ &amp; å·¥å…·"></a>âœ¨ <code>Skills &amp; Tools</code> - <code>æŠ€èƒ½ &amp; å·¥å…·</code></h3><div class="language-code flex flex-row gap-2">
  <b>Frontend: </b>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/javascript/javascript-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/typescript/typescript-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/react/react-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/redux/redux-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/vuejs/vuejs-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/nuxtjs/nuxtjs-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/angularjs/angularjs-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/html5/html5-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/css3/css3-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/sass/sass-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/tailwindcss/tailwindcss-plain.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/babel/babel-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/webpack/webpack-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/npm/npm-original-wordmark.svg" /></span>
</div>

<div class="language-code flex flex-row gap-2">
  <b>Backend: </b>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/nodejs/nodejs-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/php/php-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/laravel/laravel-plain.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/mysql/mysql-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/postgresql/postgresql-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/mongodb/mongodb-original.svg" /></span>
</div>

<div class="language-code flex flex-row gap-2">
  <b>Dev Tools: </b>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/git/git-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/vscode/vscode-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/chrome/chrome-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/androidstudio/androidstudio-original.svg" /></span>
  <span><img height="25" width="25" src="https://cdn.jsdelivr.net/gh/devicons/devicon/icons/xcode/xcode-original.svg" /></span>
</div>

<h3 id="ğŸ“œ-Experiences-ç»éªŒ"><a href="#ğŸ“œ-Experiences-ç»éªŒ" class="headerlink" title="ğŸ“œ Experiences - ç»éªŒ"></a>ğŸ“œ <code>Experiences</code> - <code>ç»éªŒ</code></h3><ul>
<li>Built a CMS system from ground up.</li>
<li>Built fully customized ERP system for B2B and ecommence-shop.</li>
<li>Built a Financial Risk Control System.</li>
<li>Built themes and website for companies.</li>
<li>Built Android and IOS APP with Ionic and Angular.</li>
<li>Lead a tech team of 20+ engineers.</li>
</ul>
<h3 id="ğŸ†-Achievements-æˆå°±"><a href="#ğŸ†-Achievements-æˆå°±" class="headerlink" title="ğŸ† Achievements - æˆå°±"></a>ğŸ† <code>Achievements</code> - <code>æˆå°±</code></h3><ul>
<li>Built Obsidian.md theme recieved theme of the year for 2020.</li>
<li>Professional tech blogger on CSDN.</li>
<li>Star Blogger top 200 on CSDN in 2020.</li>
<li>Built Obsidian theme for Hexo recieved high feedback.</li>
</ul>
<h3 id="ğŸ”­-Working-on-é¡¹ç›®"><a href="#ğŸ”­-Working-on-é¡¹ç›®" class="headerlink" title="ğŸ”­ Working on - é¡¹ç›®"></a>ğŸ”­ <code>Working on</code> - <code>é¡¹ç›®</code></h3><ul>
<li><a href="https://github.com/auroral-ui/hexo-theme-aurora">Hexo theme Aurora</a></li>
<li><a href="https://github.com/TriDiamond/Obsidian-Obsidianite">Obsidian.md theme Obsidianite</a></li>
<li>Aurora UI Components - WIP</li>
<li><a href="https://github.com/TriDiamond/hexo-theme-obsidian">Hexo theme Obsidian</a></li>
<li><a href="https://github.com/TriDiamond/projects">Side Projects</a></li>
<li>and other npm packagesâ€¦</li>
</ul>
<h3 id="âœğŸ»-My-blogs-åšå®¢"><a href="#âœğŸ»-My-blogs-åšå®¢" class="headerlink" title="âœğŸ» My blogs - åšå®¢"></a>âœğŸ» <code>My blogs</code> - <code>åšå®¢</code></h3><p><a href="https://tridiamond.tech/">BLOG</a> | <a href="https://dev.to/tridiamond">DEV.TO</a> | <a href="https://blog.csdn.net/TriDiamond6">CSDN</a> | <a href="https://juejin.im/user/1873223546578589/posts">æ˜é‡‘</a> | <a href="https://www.zhihu.com/people/tridiamond">çŸ¥ä¹</a></p>
<h3 id="ğŸ’¬-Join-my-community-åŠ å…¥ç¤¾åŒº"><a href="#ğŸ’¬-Join-my-community-åŠ å…¥ç¤¾åŒº" class="headerlink" title="ğŸ’¬ Join my community - åŠ å…¥ç¤¾åŒº"></a>ğŸ’¬ <code>Join my community</code> - <code>åŠ å…¥ç¤¾åŒº</code></h3><p><a href="https://discord.gg/VC7CrYfds5"><img src="https://discordapp.com/api/guilds/801943105913225246/widget.png?style=banner2" alt="Discord Banner 2"/></a></p>',
        1, 0, 0, '2023-12-23 16:34:38.000000', '2023-12-23 16:34:30.000000', 'admin', 'admin', 0, null, 1, 2);
INSERT INTO public.blog_article (id, cover, article_name, summary, content, status, top, featured, gmt_create,
                                 gmt_modified, gmt_create_name, gmt_modified_name, is_deleted, category_id,
                                 enable_comment, article_type)
VALUES (2, '1702212229054-202201cthxrxhggtg.jpg', 'java', 'cscsdcs', e'<p>ğŸ˜‡ğŸ˜Ÿä»£ç å®ä¾‹</p><pre><code class="language-java">public void test() {
  System.out.println();
}</code></pre><p><br></p>', 1, 0, 1, '2023-12-10 20:43:56.874739', '2023-12-12 01:27:09.283108', 'admin', 'admin', 0,
        1718181725051314178, 1, 1);
INSERT INTO public.blog_article (id, cover, article_name, summary, content, status, top, featured, gmt_create,
                                 gmt_modified, gmt_create_name, gmt_modified_name, is_deleted, category_id,
                                 enable_comment, article_type)
VALUES (4, 'https://cdn.vlts.cn/articles/62fa4855e0e681e26cc5dee2db296acd.webp', null, null, e'<hr>
<p>è¿™æ˜¯ä¸€ä¸ªç•™è¨€æ¿ã€‚</p>
<div class="custom-quote tip">
<span class="custom-quote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M20.86 14.13C20 14.7 19.56 15.74 19.77 16.76C20.13 18.55 18.55 20.13 16.76 19.77C15.74 19.57 14.7 20 14.13 20.86C13.12 22.38 10.89 22.38 9.88 20.86C9.3 20 8.26 19.56 7.24 19.77C5.45 20.13 3.87 18.55 4.23 16.76C4.43 15.74 4 14.7 3.14 14.13C1.62 13.12 1.62 10.89 3.14 9.88C4 9.3 4.44 8.26 4.23 7.24C3.87 5.45 5.45 3.87 7.24 4.23C8.26 4.44 9.3 4 9.87 3.14C10.88 1.62 13.11 1.62 14.12 3.14C14.7 4 15.74 4.44 16.76 4.23C18.55 3.87 20.13 5.45 19.77 7.24C19.56 8.26 20 9.3 20.86 9.87C22.38 10.88 22.38 13.12 20.86 14.13Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M12.01 15C12.01 14.5 12.01 14.5 12.01 14.5C12.04 13.75 13 13.46 14.04 12.2C14.41 11.74 14.69 11.41 14.86 10.85C15.15 9.95 14.92 9.18 14.86 9.02C14.8 8.79 14.52 8 13.72 7.46C13.06 7.02 12.42 7 12.14 7C11.9 7 11.36 7 10.78 7.3C10.28 7.56 9.98 7.9 9.83 8.1C9.24 8.82 9.06 9.63 9 10.06"></path>
<path stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M11.99 18H12.01"></path>
</svg></span>
<p class="custom-quote-title">æç¤º</p>
<p>This is a Message Board.</p>
</div>
<hr>', 1, 0, 0, '2023-12-30 01:47:48.000000', '2023-12-30 01:47:51.000000', 'admin', 'admin', 0, null, 1, 3);
INSERT INTO public.blog_article (id, cover, article_name, summary, content, status, top, featured, gmt_create,
                                 gmt_modified, gmt_create_name, gmt_modified_name, is_deleted, category_id,
                                 enable_comment, article_type)
VALUES (5, 'https://cdn.vlts.cn/articles/62fa4855e0e681e26cc5dee2db296acd.webp', 'è™šæ‹Ÿçº¿ç¨‹', null, e'<h2 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h2><p><code>JDK19</code>äº<code>2022-09-20</code>å‘å¸ƒ<code>GA</code>ç‰ˆæœ¬ï¼Œè¯¥ç‰ˆæœ¬æä¾›äº†è™šæ‹Ÿçº¿ç¨‹çš„é¢„è§ˆåŠŸèƒ½ã€‚ä¸‹è½½<code>JDK19</code>ä¹‹åç¿»çœ‹äº†ä¸€ä¸‹æœ‰å…³è™šæ‹Ÿçº¿ç¨‹çš„ä¸€äº›æºç ï¼Œè·Ÿæ—©äº›æ—¶å€™çš„<code>Loom</code>é¡¹ç›®æ„å»ºç‰ˆæœ¬åŸºæœ¬å¹¶æ²¡æœ‰å¾ˆå¤§å‡ºå…¥ï¼Œä¹Ÿè·Ÿç¬¬ä¸‰æ–¹<code>JDK</code>å¦‚é¹…å‚çš„<code>Kona</code>è™šæ‹Ÿçº¿ç¨‹å®ç°æ–¹å¼åŸºæœ¬ä¸€è‡´ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹è™šæ‹Ÿçº¿ç¨‹è®¾è®¡ä¸æºç å®ç°ã€‚</p>
<h2 id="Platform-Thread-ä¸-Virtual-Thread"><a href="#Platform-Thread-ä¸-Virtual-Thread" class="headerlink" title="Platform Thread ä¸ Virtual Thread"></a>Platform Thread ä¸ Virtual Thread</h2><p>å› ä¸ºå¼•å…¥äº†è™šæ‹Ÿçº¿ç¨‹ï¼ŒåŸæ¥<code>JDK</code>å­˜åœ¨<code>java.lang.Thread</code>ç±»ï¼Œä¿—ç§°çº¿ç¨‹ï¼Œä¸ºäº†æ›´å¥½åœ°åŒºåˆ†è™šæ‹Ÿçº¿ç¨‹å’ŒåŸæœ‰çš„çº¿ç¨‹ç±»ï¼Œå¼•å…¥äº†ä¸€ä¸ªå…¨æ–°ç±»<code>java.lang.VirtualThread</code>ï¼ˆ<code>Thread</code>ç±»çš„ä¸€ä¸ªå­ç±»å‹ï¼‰ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯â€è™šæ‹Ÿçº¿ç¨‹â€ã€‚</p>
<ul>
<li>é¢˜å¤–è¯ï¼šåœ¨<code>Loom</code>é¡¹ç›®æ—©æœŸè§„åˆ’é‡Œé¢ï¼Œæ ¸å¿ƒ<code>API</code>å…¶å®å‘½åä¸º<code>Fiber</code>ï¼Œç›´è¯‘è¿‡æ¥å°±æ˜¯â€çº¤ç¨‹â€æˆ–è€…â€åç¨‹â€ï¼Œåæ¥æˆä¸ºäº†åºŸæ¡ˆï¼Œåœ¨ä¸€äº›å†å²æäº¤çš„<code>Test</code>ç±»æˆ–è€…æ–‡æ¡£ä¸­è¿˜èƒ½çœ‹åˆ°ç±»ä¼¼äºä¸‹é¢çš„ä»£ç ï¼š</li>
</ul>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// java.lang.Fiber</span></span>
<span class="line"><span style="color: #E5C07B">Fiber</span><span style="color: #E06C75"> f </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Fiber</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">execute</span><span style="color: #ABB2BF">(&#123;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Good morning&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">readLock</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lock</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Good night&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125; </span><span style="color: #C678DD">finally</span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">readLock</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unlock</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125;</span></span>
<span class="line"><span style="color: #ABB2BF">    </span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Good night&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;);</span></span></code></pre></div><p><code>Thread</code>åœ¨æ­¤åŸºç¡€ä¸Šåšäº†ä¸å°‘å…¼å®¹æ€§å·¥ä½œã€‚æ­¤å¤–ï¼Œè¿˜åº”ç”¨äº†å»ºé€ è€…æ¨¡å¼å¼•å…¥äº†çº¿ç¨‹å»ºé€ å™¨ï¼Œæä¾›äº†é™æ€å·¥å‚æ–¹æ³•<code>Thread#ofPlatform()</code>å’Œ<code>Thread#ofVirtual()</code>åˆ†åˆ«ç”¨äºå®ä¾‹åŒ–<code>Thread</code>ï¼ˆå·¥å‚ï¼‰å»ºé€ å™¨å’Œ<code>VirtualThread</code>ï¼ˆå·¥å‚ï¼‰å»ºé€ å™¨ï¼Œé¡¾åæ€ä¹‰ï¼Œä¸¤ç§å»ºé€ å™¨åˆ†åˆ«ç”¨äºåˆ›å»º<code>Thread</code>æˆ–è€…<code>VirtualThread</code>ï¼Œä¾‹å¦‚ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// demo-1 build platform thread</span></span>
<span class="line"><span style="color: #E5C07B">Thread</span><span style="color: #E06C75"> platformThread </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ofPlatform</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">daemon</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;worker&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unstarted</span><span style="color: #ABB2BF">(runnable);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// demo-2 create platform thread factory</span></span>
<span class="line"><span style="color: #E5C07B">ThreadFactory</span><span style="color: #E06C75"> platformThreadFactory </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ofPlatform</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">daemon</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;worker-&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">factory</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// demo-3 build virtual thread</span></span>
<span class="line"><span style="color: #E5C07B">Thread</span><span style="color: #E06C75"> virtualThread </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ofVirtual</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;virtual-worker&quot;</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">unstarted</span><span style="color: #ABB2BF">(runnable);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// demo-4 create virtual thread factory</span></span>
<span class="line"><span style="color: #E5C07B">ThreadFactory</span><span style="color: #E06C75"> virtualThreadFactory </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">ofVirtual</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">name</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;virtual-worker-&quot;</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">).</span><span style="color: #61AFEF">factory</span><span style="color: #ABB2BF">();</span></span></code></pre></div><p>æ›´æ–°çš„<code>JDK</code>æ–‡æ¡£ä¸­ä¹ŸæŠŠåŸæ¥çš„<code>Thread</code>ç§°ä¸º<code>Platform Thread</code>ï¼Œå¯ä»¥æ›´æ˜æ™°åœ°ä¸<code>Virtual Thread</code>åŒºåˆ†å¼€æ¥ã€‚è¿™é‡Œ<code>Platform Thread</code>ç›´è¯‘ä¸ºâ€å¹³å°çº¿ç¨‹â€ï¼Œå…¶å®å°±æ˜¯â€è™šæ‹Ÿçº¿ç¨‹â€å‡ºç°ä¹‹å‰çš„è€ç”Ÿå¸¸è°ˆçš„â€çº¿ç¨‹â€ã€‚</p>
<blockquote><span class="custom-blockquote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z" undefined="1"></path>
<path fill="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z" undefined="1"></path>
<path fill="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z"></path>
</svg>
</span><p>åæ–‡ä¼šæŠŠ Platform Thread ç§°ä¸ºå¹³å°çº¿ç¨‹ï¼ŒVirtual Thread ç§°ä¸ºè™šæ‹Ÿçº¿ç¨‹ï¼Œæˆ–è€…ç›´æ¥ç”¨å…¶è‹±æ–‡åç§°</p></blockquote>
<p>é‚£ä¹ˆå¹³å°çº¿ç¨‹ä¸è™šæ‹Ÿçº¿ç¨‹çš„è”ç³»å’ŒåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ<code>JDK</code>ä¸­çš„æ¯ä¸ª<code>java.lang.Thread</code>å®ä¾‹ä¹Ÿå°±æ˜¯æ¯ä¸ªå¹³å°çº¿ç¨‹å®ä¾‹éƒ½åœ¨åº•å±‚æ“ä½œç³»ç»Ÿçº¿ç¨‹ä¸Šè¿è¡Œ<code>Java</code>ä»£ç ï¼Œå¹¶ä¸”<strong>å¹³å°çº¿ç¨‹åœ¨è¿è¡Œä»£ç çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…æ•è·ç³»ç»Ÿçº¿ç¨‹</strong>ã€‚å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼Œå¹³å°çº¿ç¨‹ä¸åº•å±‚ç³»ç»Ÿçº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œå¹³å°çº¿ç¨‹å®ä¾‹æœ¬è´¨æ˜¯ç”±ç³»ç»Ÿå†…æ ¸çš„çº¿ç¨‹è°ƒåº¦ç¨‹åºè¿›è¡Œè°ƒåº¦ï¼Œå¹¶ä¸”å¹³å°çº¿ç¨‹çš„æ€»æ•°é‡å—é™äºç³»ç»Ÿçº¿ç¨‹çš„æ€»æ•°é‡ã€‚</p>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-1.webp" alt="vt-source-code-1"></p>
<p>æ€»çš„æ¥è¯´ï¼Œå¹³å°çº¿ç¨‹æœ‰ä¸‹é¢çš„ä¸€äº›ç‰¹ç‚¹æˆ–è€…è¯´é™åˆ¶ï¼š</p>
<ul>
<li>èµ„æºæœ‰é™å¯¼è‡´ç³»ç»Ÿçº¿ç¨‹æ€»é‡æœ‰é™ï¼Œè¿›è€Œå¯¼è‡´ä¸ç³»ç»Ÿçº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„å¹³å°çº¿ç¨‹æœ‰é™</li>
<li>å¹³å°çº¿ç¨‹çš„è°ƒåº¦ä¾èµ–äºç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ç¨‹åºï¼Œå½“å¹³å°çº¿ç¨‹åˆ›å»ºè¿‡å¤šï¼Œä¼šæ¶ˆè€—å¤§é‡èµ„æºç”¨äºå¤„ç†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>æ¯ä¸ªå¹³å°çº¿ç¨‹éƒ½ä¼šå¼€è¾Ÿä¸€å—ç§æœ‰çš„æ ˆç©ºé—´ï¼Œå¤§é‡å¹³å°çº¿ç¨‹ä¼šå æ®å¤§é‡å†…å­˜</li>
</ul>
<p>è¿™äº›é™åˆ¶å¯¼è‡´å¼€å‘è€…ä¸èƒ½æå¤§é‡åœ°åˆ›å»ºå¹³å°çº¿ç¨‹ï¼Œä¸ºäº†æ»¡è¶³æ€§èƒ½éœ€è¦ï¼Œéœ€è¦å¼•å…¥æ± åŒ–æŠ€æœ¯ã€æ·»åŠ ä»»åŠ¡é˜Ÿåˆ—æ„å»ºæ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼ç­‰æ–¹æ¡ˆå»è®©å¹³å°çº¿ç¨‹é€‚é…å¤šå˜çš„ç°å®åœºæ™¯ã€‚æ˜¾ç„¶ï¼Œå¼€å‘è€…ä»¬è¿«åˆ‡éœ€è¦ä¸€ç§è½»é‡çº§çº¿ç¨‹å®ç°ï¼Œåˆšå¥½å¯ä»¥å¼¥è¡¥ä¸Šé¢æåˆ°çš„å¹³å°çº¿ç¨‹çš„é™åˆ¶ï¼Œè¿™ç§è½»é‡çº§çº¿ç¨‹å¯ä»¥æ»¡è¶³ï¼š</p>
<ul>
<li>å¯ä»¥å¤§é‡åˆ›å»ºï¼Œä¾‹å¦‚åä¸‡çº§åˆ«ã€ç™¾ä¸‡çº§åˆ«ï¼Œè€Œä¸ä¼šå æ®å¤§é‡å†…å­˜</li>
<li>ç”±<code>JVM</code>è¿›è¡Œè°ƒåº¦å’ŒçŠ¶æ€åˆ‡æ¢ï¼Œå¹¶ä¸”ä¸ç³»ç»Ÿçº¿ç¨‹â€æ¾ç»‘â€</li>
<li>ç”¨æ³•ä¸åŸæ¥å¹³å°çº¿ç¨‹å·®ä¸å¤šï¼Œæˆ–è€…è¯´å°½é‡å…¼å®¹å¹³å°çº¿ç¨‹ç°å­˜çš„<code>API</code></li>
</ul>
<p><code>Loom</code>é¡¹ç›®ä¸­å¼€å‘çš„è™šæ‹Ÿçº¿ç¨‹å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œçœ‹èµ·æ¥å®ƒçš„è¿è¡Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-2.webp" alt="vt-source-code-2"></p>
<p>å½“ç„¶ï¼Œå¹³å°çº¿ç¨‹ä¸æ˜¯ç®€å•åœ°ä¸è™šæ‹Ÿçº¿ç¨‹è¿›è¡Œ<code>1:N</code>çš„ç»‘å®šï¼Œåé¢çš„ç« èŠ‚ä¼šæ·±å…¥åˆ†æè™šæ‹Ÿçº¿ç¨‹çš„è¿è¡ŒåŸç†ã€‚</p>
<h2 id="è™šæ‹Ÿçº¿ç¨‹å®ç°åŸç†"><a href="#è™šæ‹Ÿçº¿ç¨‹å®ç°åŸç†" class="headerlink" title="è™šæ‹Ÿçº¿ç¨‹å®ç°åŸç†"></a>è™šæ‹Ÿçº¿ç¨‹å®ç°åŸç†</h2><p>è™šæ‹Ÿçº¿ç¨‹æ˜¯ä¸€ç§è½»é‡çº§ï¼ˆç”¨æˆ·æ¨¡å¼ï¼‰çº¿ç¨‹ï¼Œè¿™ç§çº¿ç¨‹æ˜¯ç”±<code>Java</code>è™šæ‹Ÿæœºè°ƒåº¦ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»Ÿã€‚è™šæ‹Ÿçº¿ç¨‹å ç”¨ç©ºé—´å°ï¼Œä»»åŠ¡åˆ‡æ¢å¼€é”€å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ï¼Œå› æ­¤å¯ä»¥æå¤§é‡åœ°åˆ›å»ºå’Œä½¿ç”¨ã€‚æ€»ä½“æ¥çœ‹ï¼Œè™šæ‹Ÿçº¿ç¨‹å®ç°å¦‚ä¸‹ï¼š</p>
<div class="language-shell"><button title="Copy code" class="copy"></button><span class="lang">shell</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #61AFEF">virtual</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">thread</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">=</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">continuation</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">+</span><span style="color: #ABB2BF"> </span><span style="color: #98C379">scheduler</span></span></code></pre></div><p>è™šæ‹Ÿçº¿ç¨‹ä¼šæŠŠä»»åŠ¡ï¼ˆä¸€èˆ¬æ˜¯<code>java.lang.Runnable</code>ï¼‰åŒ…è£…åˆ°ä¸€ä¸ª<code>Continuation</code>å®ä¾‹ä¸­ï¼š</p>
<ul>
<li>å½“ä»»åŠ¡éœ€è¦é˜»å¡æŒ‚èµ·çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<code>Continuation</code>çš„<code>yield</code>æ“ä½œè¿›è¡Œé˜»å¡</li>
<li>å½“ä»»åŠ¡éœ€è¦è§£é™¤é˜»å¡ç»§ç»­æ‰§è¡Œçš„æ—¶å€™ï¼Œ<code>Continuation</code>ä¼šè¢«ç»§ç»­æ‰§è¡Œ</li>
</ul>
<p><code>Scheduler</code>ä¹Ÿå°±æ˜¯æ‰§è¡Œå™¨ï¼Œä¼šæŠŠä»»åŠ¡æäº¤åˆ°ä¸€ä¸ªè½½ä½“çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼š</p>
<ul>
<li>æ‰§è¡Œå™¨æ˜¯<code>java.util.concurrent.Executor</code>çš„å­ç±»</li>
<li>è™šæ‹Ÿçº¿ç¨‹æ¡†æ¶æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„<code>ForkJoinPool</code>ç”¨äºæ‰§è¡Œè™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡</li>
</ul>
<blockquote><span class="custom-blockquote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z" undefined="1"></path>
<path fill="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z" undefined="1"></path>
<path fill="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z"></path>
</svg>
</span><p>ä¸‹æ–‡ä¼šæŠŠ carrier thread ç§°ä¸ºâ€è½½ä½“çº¿ç¨‹â€ï¼ŒæŒ‡çš„æ˜¯è´Ÿè´£æ‰§è¡Œè™šæ‹Ÿçº¿ç¨‹ä¸­ä»»åŠ¡çš„å¹³å°çº¿ç¨‹ï¼Œæˆ–è€…è¯´è¿è¡Œè™šæ‹Ÿçº¿ç¨‹çš„å¹³å°çº¿ç¨‹ç§°ä¸ºå®ƒçš„è½½ä½“çº¿ç¨‹</p></blockquote>
<p>æ“ä½œç³»ç»Ÿè°ƒåº¦ç³»ç»Ÿçº¿ç¨‹ï¼Œè€Œ<code>Java</code>å¹³å°çº¿ç¨‹ä¸ç³»ç»Ÿçº¿ç¨‹ä¸€ä¸€æ˜ å°„ï¼Œæ‰€ä»¥å¹³å°çº¿ç¨‹è¢«æ“ä½œç³»ç»Ÿè°ƒåº¦ï¼Œä½†æ˜¯è™šæ‹Ÿçº¿ç¨‹æ˜¯ç”±<code>JVM</code>è°ƒåº¦ã€‚<code>JVM</code>æŠŠè™šæ‹Ÿçº¿ç¨‹åˆ†é…ç»™å¹³å°çº¿ç¨‹çš„æ“ä½œç§°ä¸º<code>mount</code>ï¼ˆæŒ‚è½½ï¼‰ï¼Œåè¿‡æ¥å–æ¶ˆåˆ†é…å¹³å°çº¿ç¨‹çš„æ“ä½œç§°ä¸º<code>unmount</code>ï¼ˆå¸è½½ï¼‰ï¼š</p>
<ul>
<li><code>mount</code>æ“ä½œï¼šè™šæ‹Ÿçº¿ç¨‹æŒ‚è½½åˆ°å¹³å°çº¿ç¨‹ï¼Œè™šæ‹Ÿçº¿ç¨‹ä¸­åŒ…è£…çš„<code>Continuation</code>æ ˆæ•°æ®å¸§æˆ–è€…å¼•ç”¨æ ˆæ•°æ®ä¼šè¢«æ‹·è´åˆ°å¹³å°çº¿ç¨‹çš„çº¿ç¨‹æ ˆï¼Œè¿™æ˜¯ä¸€ä¸ªä»å †å¤åˆ¶åˆ°æ ˆçš„è¿‡ç¨‹</li>
<li><code>unmount</code>æ“ä½œï¼šè™šæ‹Ÿçº¿ç¨‹ä»å¹³å°çº¿ç¨‹å¸è½½ï¼Œå¤§å¤šæ•°è™šæ‹Ÿçº¿ç¨‹ä¸­åŒ…è£…çš„<code>Continuation</code>æ ˆæ•°æ®å¸§ä¼šç•™åœ¨å †å†…å­˜ä¸­</li>
</ul>
<p>è¿™ä¸ª<code>mount -&gt; run -&gt; unmount</code>è¿‡ç¨‹ç”¨ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #61AFEF">mount</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">Continuation</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">&#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #61AFEF">unmount</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span></code></pre></div><p>ä»<code>Java</code>ä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œè™šæ‹Ÿçº¿ç¨‹å’Œå®ƒçš„è½½ä½“çº¿ç¨‹æš‚æ—¶å…±äº«ä¸€ä¸ª<code>OS</code>çº¿ç¨‹å®ä¾‹è¿™ä¸ªäº‹å®æ˜¯ä¸å¯è§ï¼Œå› ä¸ºè™šæ‹Ÿçº¿ç¨‹çš„å †æ ˆè·Ÿè¸ªå’Œçº¿ç¨‹æœ¬åœ°å˜é‡ä¸å¹³å°çº¿ç¨‹æ˜¯å®Œå…¨éš”ç¦»çš„ã€‚<code>JDK</code>ä¸­ä¸“é—¨æ˜¯ç”¨äº†ä¸€ä¸ª<code>FIFO</code>æ¨¡å¼çš„<code>ForkJoinPool</code>ä½œä¸ºè™šæ‹Ÿçº¿ç¨‹çš„è°ƒåº¦ç¨‹åºï¼Œä»è¿™ä¸ªè°ƒåº¦ç¨‹åºçœ‹è™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡çš„æ‰§è¡Œæµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p>
<ul>
<li>è°ƒåº¦å™¨ï¼ˆçº¿ç¨‹æ± ï¼‰ä¸­çš„å¹³å°çº¿ç¨‹ç­‰å¾…å¤„ç†ä»»åŠ¡</li>
</ul>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-5.webp" alt="vt-source-code-5"></p>
<ul>
<li>ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹è¢«åˆ†é…å¹³å°çº¿ç¨‹ï¼Œè¯¥å¹³å°çº¿ç¨‹ä½œä¸ºè¿è½½çº¿ç¨‹æ‰§è¡Œè™šæ‹Ÿçº¿ç¨‹ä¸­çš„ä»»åŠ¡</li>
</ul>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-6.webp" alt="vt-source-code-6"></p>
<ul>
<li>è™šæ‹Ÿçº¿ç¨‹è¿è¡Œå…¶<code>Continuation</code>ï¼Œä»è€Œæ‰§è¡ŒåŸºäº<code>Runnable</code>åŒ…è£…çš„ç”¨æˆ·ä»»åŠ¡</li>
</ul>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-7.webp" alt="vt-source-code-7"></p>
<ul>
<li>è™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ ‡è®°<code>Continuation</code>ç»ˆç»“ï¼Œæ ‡è®°è™šæ‹Ÿçº¿ç¨‹ä¸ºç»ˆç»“çŠ¶æ€ï¼Œæ¸…ç©ºä¸€äº›ä¸Šä¸‹æ–‡å˜é‡ï¼Œè¿è½½çº¿ç¨‹â€è¿”è¿˜â€åˆ°è°ƒåº¦å™¨ï¼ˆçº¿ç¨‹æ± ï¼‰ä¸­ä½œä¸ºå¹³å°çº¿ç¨‹ç­‰å¾…å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡</li>
</ul>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-5.webp" alt="vt-source-code-5"></p>
<p>ä¸Šé¢æ˜¯æè¿°ä¸€èˆ¬çš„è™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡æ‰§è¡Œæƒ…å†µï¼Œåœ¨æ‰§è¡Œä»»åŠ¡æ—¶å€™é¦–æ¬¡è°ƒç”¨<code>Continuation#run()</code>è·å–é”ï¼ˆ<code>ReentrantLock</code>ï¼‰çš„æ—¶å€™ä¼šè§¦å‘<code>Continuation</code>çš„<code>yield</code>æ“ä½œè®©å‡ºæ§åˆ¶æƒï¼Œç­‰å¾…è™šæ‹Ÿçº¿ç¨‹é‡æ–°åˆ†é…è¿è½½çº¿ç¨‹å¹¶ä¸”æ‰§è¡Œï¼Œè§ä¸‹é¢çš„ä»£ç ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #C678DD">public</span><span style="color: #E06C75"> </span><span style="color: #C678DD">class</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">VirtualThreadLock</span><span style="color: #E06C75"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">public</span><span style="color: #61AFEF"> </span><span style="color: #C678DD">static</span><span style="color: #61AFEF"> </span><span style="color: #C678DD">void</span><span style="color: #61AFEF"> main</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75; font-style: italic">args</span><span style="color: #ABB2BF">)</span><span style="color: #61AFEF"> </span><span style="color: #C678DD">throws</span><span style="color: #61AFEF"> </span><span style="color: #E5C07B">Exception</span><span style="color: #61AFEF"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">ReentrantLock</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">lock</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ReentrantLock</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">startVirtualThread</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">-&gt;</span><span style="color: #ABB2BF"> &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">lock</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lock</span><span style="color: #ABB2BF">();     </span><span style="color: #7F848E; font-style: italic">// &lt;------ è¿™é‡Œç¡®ä¿é”å·²ç»è¢«å¦ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹æŒæœ‰</span></span>
<span class="line"><span style="color: #ABB2BF">        &#125;);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">sleep</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1000</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">startVirtualThread</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">-&gt;</span><span style="color: #ABB2BF"> &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;first&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">lock</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lock</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">try</span><span style="color: #ABB2BF"> &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;second&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">            &#125; </span><span style="color: #C678DD">finally</span><span style="color: #ABB2BF"> &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">                </span><span style="color: #E5C07B">lock</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">unlock</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">            &#125;</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;third&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        &#125;);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">sleep</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Long</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">MAX_VALUE</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125;</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span></code></pre></div><ul>
<li>è™šæ‹Ÿçº¿ç¨‹ä¸­ä»»åŠ¡æ‰§è¡Œæ—¶å€™é¦–æ¬¡è°ƒç”¨<code>Continuation#run()</code>æ‰§è¡Œäº†éƒ¨åˆ†ä»»åŠ¡ä»£ç ï¼Œç„¶åå°è¯•è·å–é”ï¼Œä¼šå¯¼è‡´<code>Continuation</code>çš„<code>yield</code>æ“ä½œè®©å‡ºæ§åˆ¶æƒï¼ˆä»»åŠ¡åˆ‡æ¢ï¼‰ï¼Œä¹Ÿå°±æ˜¯<code>unmount</code>ï¼Œè¿è½½çº¿ç¨‹æ ˆæ•°æ®ä¼šç§»åŠ¨åˆ°<code>Continuation</code>æ ˆçš„æ•°æ®å¸§ä¸­ï¼Œä¿å­˜åœ¨å †å†…å­˜ï¼Œè™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡å®Œæˆï¼ˆä½†æ˜¯è™šæ‹Ÿçº¿ç¨‹æ²¡æœ‰ç»ˆç»“ï¼ŒåŒæ—¶å…¶<code>Continuation</code>ä¹Ÿæ²¡æœ‰ç»ˆç»“å’Œé‡Šæ”¾ï¼‰ï¼Œè¿è½½çº¿ç¨‹è¢«é‡Šæ”¾åˆ°æ‰§è¡Œå™¨ä¸­ç­‰å¾…æ–°çš„ä»»åŠ¡ï¼›å¦‚æœ<code>Continuation</code>çš„<code>yield</code>æ“ä½œå¤±è´¥ï¼Œåˆ™ä¼šå¯¹è¿è½½çº¿ç¨‹è¿›è¡Œ<code>park</code>è°ƒç”¨ï¼Œé˜»å¡åœ¨è¿è½½çº¿ç¨‹ä¸Š</li>
</ul>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-8.webp" alt="vt-source-code-8"></p>
<ul>
<li>å½“é”æŒæœ‰è€…é‡Šæ”¾é”ä¹‹åï¼Œä¼šå”¤é†’è™šæ‹Ÿçº¿ç¨‹è·å–é”ï¼ˆæˆåŠŸåï¼‰ï¼Œè™šæ‹Ÿçº¿ç¨‹ä¼šé‡æ–°è¿›è¡Œ<code>mount</code>ï¼Œè®©è™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡å†æ¬¡æ‰§è¡Œï¼Œæœ‰å¯èƒ½æ˜¯åˆ†é…åˆ°å¦ä¸€ä¸ªè¿è½½çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œ<code>Continuation</code>æ ˆä¼šçš„æ•°æ®å¸§ä¼šè¢«æ¢å¤åˆ°è¿è½½çº¿ç¨‹æ ˆä¸­ï¼Œç„¶åå†æ¬¡è°ƒç”¨<code>Continuation#run()</code>æ¢å¤ä»»åŠ¡æ‰§è¡Œï¼š</li>
</ul>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-9.webp" alt="vt-source-code-9"></p>
<ul>
<li>æœ€ç»ˆè™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ ‡è®°<code>Continuation</code>ç»ˆç»“ï¼Œæ ‡è®°è™šæ‹Ÿçº¿ç¨‹ä¸ºç»ˆç»“çŠ¶æ€ï¼Œæ¸…ç©ºä¸€äº›ä¸Šä¸‹æ–‡å˜é‡ï¼Œè¿è½½çº¿ç¨‹â€è¿”è¿˜â€åˆ°è°ƒåº¦å™¨ï¼ˆçº¿ç¨‹æ± ï¼‰ä¸­ä½œä¸ºå¹³å°çº¿ç¨‹ç­‰å¾…å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡</li>
</ul>
<p><code>Continuation</code>ç»„ä»¶ååˆ†é‡è¦ï¼Œå®ƒæ—¢æ˜¯ç”¨æˆ·çœŸå®ä»»åŠ¡çš„åŒ…è£…å™¨ï¼Œä¹Ÿæ˜¯ä»»åŠ¡åˆ‡æ¢è™šæ‹Ÿçº¿ç¨‹ä¸å¹³å°çº¿ç¨‹ä¹‹é—´æ•°æ®è½¬ç§»çš„ä¸€ä¸ªå¥æŸ„ï¼Œå®ƒæä¾›çš„<code>yield</code>æ“ä½œå¯ä»¥å®ç°ä»»åŠ¡ä¸Šä¸‹æ–‡çš„ä¸­æ–­å’Œæ¢å¤ã€‚ç”±äº<code>Continuation</code>è¢«å°é—­åœ¨<code>java.base/jdk.internal.vm</code>ä¸‹ï¼Œå¯ä»¥é€šè¿‡å¢åŠ ç¼–è¯‘å‚æ•°<code>--add-exports java.base/jdk.internal.vm=ALL-UNNAMED</code>æš´éœ²å¯¹åº”çš„åŠŸèƒ½ï¼Œä»è€Œç¼–å†™å®éªŒæ€§æ¡ˆä¾‹ï¼Œ<code>IDEA</code>ä¸­å¯ä»¥æŒ‰ä¸‹å›¾è¿›è¡Œç¼–è¯‘å‚æ•°æ·»åŠ ï¼š</p>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-10.webp" alt="vt-source-code-10"></p>
<p>ç„¶åç¼–å†™å’Œè¿è¡Œä¸‹é¢çš„ä¾‹å­ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #C678DD">import</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">jdk.internal.vm.Continuation</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">import</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">jdk.internal.vm.ContinuationScope</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #E06C75"> </span><span style="color: #C678DD">class</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ContinuationDemo</span><span style="color: #E06C75"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">public</span><span style="color: #61AFEF"> </span><span style="color: #C678DD">static</span><span style="color: #61AFEF"> </span><span style="color: #C678DD">void</span><span style="color: #61AFEF"> main</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">String</span><span style="color: #ABB2BF">[] </span><span style="color: #E06C75; font-style: italic">args</span><span style="color: #ABB2BF">)</span><span style="color: #61AFEF"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">ContinuationScope</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">scope</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">ContinuationScope</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;scope&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">Continuation</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">continuation</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> </span><span style="color: #C678DD">new</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">Continuation</span><span style="color: #ABB2BF">(scope, () </span><span style="color: #C678DD">-&gt;</span><span style="color: #ABB2BF"> &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Running before yield&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">Continuation</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">yield</span><span style="color: #ABB2BF">(scope);</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Running after yield&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        &#125;);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;First run&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic">// ç¬¬ä¸€æ¬¡æ‰§è¡ŒContinuation.run</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">continuation</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Second run&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #7F848E; font-style: italic">// ç¬¬äºŒæ¬¡æ‰§è¡ŒContinuation.run</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">continuation</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">println</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;Done&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125;</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è¿è¡Œä»£ç ï¼Œç¥å¥‡çš„ç»“æœå‡ºç°äº†</span></span>
<span class="line"><span style="color: #E5C07B">First</span><span style="color: #E06C75"> run</span></span>
<span class="line"><span style="color: #E5C07B">Running</span><span style="color: #E06C75"> before </span><span style="color: #C678DD">yield</span></span>
<span class="line"><span style="color: #E5C07B">Second</span><span style="color: #E06C75"> run</span></span>
<span class="line"><span style="color: #E5C07B">Running</span><span style="color: #E06C75"> after </span><span style="color: #C678DD">yield</span></span>
<span class="line"><span style="color: #E5C07B">Done</span></span></code></pre></div><p>è¿™é‡Œå¯ä»¥çœ‹å‡º<code>Continuation</code>çš„å¥‡å¦™ä¹‹å¤„ï¼Œ<code>Continuation</code>å®ä¾‹è¿›è¡Œ<code>yield</code>è°ƒç”¨åï¼Œå†æ¬¡è°ƒç”¨å…¶<code>run</code>æ–¹æ³•å°±å¯ä»¥ä»<code>yield</code>çš„è°ƒç”¨ä¹‹å¤„å¾€ä¸‹æ‰§è¡Œï¼Œä»è€Œå®ç°äº†ç¨‹åºçš„ä¸­æ–­å’Œæ¢å¤ã€‚</p>
<h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p>ä¸»è¦åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>Continuation</code></li>
<li><code>VirtualThread</code></li>
<li>çº¿ç¨‹å»ºé€ å™¨</li>
</ul>
<h3 id="Continuation"><a href="#Continuation" class="headerlink" title="Continuation"></a>Continuation</h3><p><code>Continuation</code>ç›´è¯‘ä¸ºâ€è¿ç»­â€ï¼Œä¸€èˆ¬æ¥è¯´è¡¨ç¤ºä¸€ç§è¯­è¨€æ„é€ ï¼Œ<strong>ä½¿è¯­è¨€å¯ä»¥åœ¨ä»»æ„ç‚¹ä¿å­˜æ‰§è¡ŒçŠ¶æ€å¹¶ä¸”åœ¨ä¹‹åçš„æŸä¸ªç‚¹è¿”å›</strong>ã€‚åœ¨<code>JDK</code>ä¸­å¯¹åº”ç±»<code>jdk.internal.vm.Continuation</code>ï¼Œè¿™ä¸ªç±»åªæœ‰ä¸€å¥ç±»æ³¨é‡Š<code>A one-shot delimited continuation</code>ï¼Œç›´è¯‘ä¸º<strong>ä¸€ä¸ªåªèƒ½æ‰§è¡Œä¸€æ¬¡çš„å›è°ƒå‡½æ•°</strong>ã€‚ç”±äº<code>Continuation</code>çš„æˆå‘˜å’Œæ–¹æ³•ç¼ºå°‘è¯¦ç»†çš„æ³¨é‡Šï¼Œå¹¶ä¸”å¤§éƒ¨åˆ†åŠŸèƒ½ç”±<code>JVM</code>å®ç°ï¼Œè¿™é‡Œåªèƒ½é˜…è¯»å…¶ä¸€äº›éª¨å¹²æºç å’Œä¸Šä¸€å°èŠ‚ç¼–å†™çš„<code>Continuation</code>ç›¸å…³ä¾‹å­å»äº†è§£å…¶å®ç°ï¼ˆç¬”è€…<code>C</code>è¯­è¨€æ¯”è¾ƒè–„å¼±ï¼Œæœ‰å…´è¶£çš„å¯ä»¥ç¿»é˜…<code>JVM</code>çš„æºç ï¼‰ã€‚å…ˆçœ‹æˆå‘˜å˜é‡å’Œæ„é€ å‡½æ•°ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿ç•™å½“å‰çº¿ç¨‹çš„æœ¬åœ°ç¼“å­˜ï¼Œç”±ç³»ç»Ÿå‚æ•°jdk.preserveExtentLocalCacheå†³å®š</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> PRESERVE_EXTENT_LOCAL_CACHE</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// çœŸæ­£è¦è¢«æ‰§è¡Œçš„ä»»åŠ¡å®ä¾‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Runnable</span><span style="color: #E06C75"> target</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æ ‡è¯†Continuationçš„èŒƒå›´ï¼Œ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ContinuationScope</span><span style="color: #E06C75"> scope</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuationçš„çˆ¶èŠ‚ç‚¹ï¼Œå¦‚æœä¸ºç©ºçš„æ—¶å€™åˆ™ä¸ºæœ¬åœ°çº¿ç¨‹æ ˆ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> parent</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuationçš„å­èŠ‚ç‚¹ï¼Œéç©ºæ—¶å€™è¯´æ˜åœ¨å­Continuationä¸­è¿›è¡Œäº†yieldæ“ä½œ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> child</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// çŒœæµ‹ä¸ºContinuationæ ˆç»“æ„ï¼Œç”±JVMç®¡ç†ï¼Œæ— æ³•å¾—çŸ¥å…¶çœŸå®ä½œç”¨</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">StackChunk</span><span style="color: #E06C75"> tail</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æ ‡è®°Continuationæ˜¯å¦å·²ç»å®Œæˆ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> done</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æ ‡è®°æ˜¯å¦è¿›è¡Œäº†mountæ“ä½œ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">volatile</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> mounted </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// yieldæ“ä½œæ—¶å€™è®¾ç½®çš„ä¿¡æ¯</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Object</span><span style="color: #E06C75"> yieldInfo</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æ ‡è®°ä¸€ä¸ªæœªæŒ‚è½½çš„Continuationæ˜¯å¦é€šè¿‡å¼ºåˆ¶æŠ¢å å¼å¸è½½</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> preempted</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// ä¿ç•™å½“å‰çº¿ç¨‹çš„æœ¬åœ°ç¼“å­˜çš„å‰¯æœ¬</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Object</span><span style="color: #E06C75">[] extentLocalCache</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æ„é€ å‡½æ•°ï¼Œè¦æ±‚ä¼ å…¥èŒƒå›´å’Œä»»åŠ¡åŒ…è£…å®ä¾‹</span></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">Continuation</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">ContinuationScope</span><span style="color: #E06C75"> scope</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Runnable</span><span style="color: #E06C75"> target) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scope</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> scope</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">target</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> target</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span></code></pre></div><p><code>Continuation</code>æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨è®¾è®¡ï¼Œå®ƒçš„å”¯ä¸€ä¸€ç»„æ„é€ å‚æ•°æ˜¯<code>ContinuationScope</code>å’Œ<code>Runnable</code>ï¼š</p>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-11.webp" alt="vt-source-code-11"></p>
<p>è¿™é‡Œä¸æ·±å…¥ç ”ç©¶å†…éƒ¨<code>StackChunk</code>ã€<code>Pinned</code>ç­‰å®ç°ï¼Œç›´æ¥çœ‹<code>run</code>ã€<code>enter</code>ç³»åˆ—æ–¹æ³•å’Œ<code>yield</code>æ–¹æ³•ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// Continuation.run()</span></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">run</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// è®¾ç½®æ­»å¾ªç¯</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">while</span><span style="color: #E06C75"> (</span><span style="color: #D19A66">true</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// è¿›è¡Œmountæ“ä½œ</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">mount</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">setExtentLocalCache</span><span style="color: #ABB2BF">(extentLocalCache);</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// å¦‚æœContinuationå·²å®Œæˆåˆ™æŠ›å‡ºå¼‚å¸¸</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (done)</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">IllegalStateException</span><span style="color: #E06C75">(</span><span style="color: #98C379">&quot;Continuation terminated&quot;</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// è·å–å½“å‰è™šæ‹Ÿçº¿ç¨‹åˆ†é…çš„è¿è½½çº¿ç¨‹</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">Thread</span><span style="color: #E06C75"> t </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">currentCarrierThread</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (parent </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (parent </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getContinuation</span><span style="color: #ABB2BF">(t)</span><span style="color: #E06C75">)</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">IllegalStateException</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">parent</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getContinuation</span><span style="color: #ABB2BF">(t);</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// è¿è½½çº¿ç¨‹è®¾ç½®å½“å‰Continuationå®ä¾‹</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">setContinuation</span><span style="color: #ABB2BF">(t, </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// åˆ¤æ–­ContinuationScopeæ˜¯å¦è™šæ‹Ÿçº¿ç¨‹èŒƒå›´</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> isVirtualThread </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> (scope </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">virtualThreadContinuationScope</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">isStarted</span><span style="color: #E06C75">()) &#123; </span><span style="color: #7F848E; font-style: italic">// is this the first run? (at this point we know !done)</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// æ¿€æ´»enterç³»åˆ—æ–¹æ³•ï¼Œæ ‡è®°isContinueä¸ºfalseï¼Œæ ‡è®°æ˜¯å¦è™šæ‹Ÿçº¿ç¨‹èŒƒå›´</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #61AFEF">enterSpecial</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> isVirtualThread)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">isEmpty</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// æ¿€æ´»enterç³»åˆ—æ–¹æ³•ï¼Œæ ‡è®°isContinueä¸ºtrueï¼Œæ ‡è®°æ˜¯å¦è™šæ‹Ÿçº¿ç¨‹èŒƒå›´</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #61AFEF">enterSpecial</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> isVirtualThread)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            &#125;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// è®¾ç½®å†…å­˜å±éšœ</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">fence</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">isEmpty</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> done </span><span style="color: #ABB2BF">:</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;empty: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">isEmpty</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot; done: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> done </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot; cont: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Integer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">toHexString</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">identityHashCode</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">));</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// å½“å‰Continuationæ‰§è¡Œå®Œæˆåï¼ŒæŠŠè¿è½½çº¿ç¨‹çš„ContinuationæŒ‡å‘çˆ¶Continuation</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">setContinuation</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">currentCarrierThread</span><span style="color: #ABB2BF">(), </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">parent</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (parent </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">)</span></span>
<span class="line"><span style="color: #E06C75">                    </span><span style="color: #E5C07B">parent</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">child</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// è¿›è¡Œåç½®çš„yieldæ¸…ç†å·¥ä½œ</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #61AFEF">postYieldCleanup</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// è¿›è¡Œunmountæ“ä½œ</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #61AFEF">unmount</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// åˆ¤æ–­æ˜¯å¦éœ€è¦ä¿ç•™å½“å‰çº¿ç¨‹çš„æœ¬åœ°ç¼“å­˜å¹¶å¤„ç†</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (PRESERVE_EXTENT_LOCAL_CACHE) &#123;</span></span>
<span class="line"><span style="color: #E06C75">                    extentLocalCache </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">extentLocalCache</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">                &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">                    extentLocalCache </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">                &#125;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">setExtentLocalCache</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">            &#125; </span><span style="color: #C678DD">catch</span><span style="color: #E06C75"> (</span><span style="color: #E5C07B">Throwable</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">e</span><span style="color: #E06C75">) &#123; </span><span style="color: #E5C07B">e</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">printStackTrace</span><span style="color: #ABB2BF">();</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">exit</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span><span style="color: #E06C75"> &#125;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// we&#39;re now in the parent continuation</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">||</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #C678DD">instanceof</span><span style="color: #E06C75"> ContinuationScope</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// çˆ¶Continuationçš„yieldInfoç¼“å­˜å½“å‰çš„scopeå®ä¾‹ï¼Œæ¸…ç©ºå½“å‰Continuationçš„çˆ¶èŠ‚ç‚¹å’ŒyieldInfo</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (yieldInfo </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">||</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> scope) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">parent</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">yieldInfo</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// è¿™ä¸ªä½ç½®æ˜¯æ­»å¾ªç¯çš„å”¯ä¸€è·³å‡ºç‚¹</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// æ‰§è¡Œåˆ°è¿™ä¸ªä½ç½®è¯´æ˜åœ¨å½“å‰æ˜¯å­Continuationå¹¶ä¸”è¿›è¡Œäº†yieldæ“ä½œï¼Œéœ€è¦è·³è½¬åˆ°çˆ¶Continuationè¿›è¡Œyieldæ“ä½œ</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">parent</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">child</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">parent</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">yield0</span><span style="color: #ABB2BF">((ContinuationScope)yieldInfo, </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">parent</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">child</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuation.enter()ç³»åˆ—æ–¹æ³•</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è¿™æ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œå®ƒæœ€ç»ˆä¼šæ ¹æ®åˆ¤æ–­å›è°ƒåˆ°enter()æ–¹æ³•</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">native</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">enterSpecial</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> c</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> isContinue</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> isVirtualThread)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuationçš„å…¥å£æ–¹æ³•ï¼Œç”¨æˆ·ä»»åŠ¡å›è°ƒçš„å…¥å£</span></span>
<span class="line"><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">DontInline</span></span>
<span class="line"><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">IntrinsicCandidate</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">enter</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> c</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> isContinue) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// This method runs in the &quot;entry frame&quot;.</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// A yield jumps to this method&#39;s caller as if returning from this method.</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">enter0</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">finish</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// çœŸæ­£ä»»åŠ¡åŒ…è£…å™¨æ‰§è¡Œçš„å›è°ƒæ–¹æ³•</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">enter0</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">target</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuationå®Œæˆï¼Œæ ‡è®°doneä¸ºtrue</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">finish</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    done </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">isEmpty</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuation.yield()æ–¹æ³•ï¼Œé™æ€æ–¹æ³•</span></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> </span><span style="color: #C678DD">yield</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">ContinuationScope</span><span style="color: #E06C75"> scope) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// è·å–å½“å‰è¿è½½çº¿ç¨‹çš„Continuationå®ä¾‹</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> cont </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">JLA</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getContinuation</span><span style="color: #ABB2BF">(</span><span style="color: #61AFEF">currentCarrierThread</span><span style="color: #ABB2BF">());</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> c</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// åŸºäºContinuationå®ä¾‹å½“å‰å‘çˆ¶èŠ‚ç‚¹éå†ï¼Œç›´åˆ°åŒ¹é…è™šæ‹Ÿçº¿ç¨‹ç±»å‹çš„ContinuationScopeçš„Continuationï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…çš„Continuationä¼šæŠ›å‡ºå¼‚å¸¸ä¸­æ–­æµç¨‹</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">for</span><span style="color: #E06C75"> (c </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> cont</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75"> c </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scope</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> scope</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75"> c </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">c</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">parent</span><span style="color: #E06C75">)</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (c </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">)</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">IllegalStateException</span><span style="color: #E06C75">(</span><span style="color: #98C379">&quot;Not in scope &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> scope)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// æŠŠå½“å‰çš„ContinuationæŒ‚èµ·åˆ°ç»™å®šçš„ContinuationScope</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">cont</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">yield0</span><span style="color: #ABB2BF">(scope, </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// é€è¿‡ä¸Šä¸‹æ–‡çŒœæµ‹æ˜¯å½“å‰çš„Continuationå®ä¾‹æŒ‚èµ·åˆ°ç»™å®šçš„ContinuationScope</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">yield0</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">ContinuationScope</span><span style="color: #E06C75"> scope</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> child) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¼ºåˆ¶æŠ¢å å¼å¸è½½æ ‡è®°ä¸ºfalse</span></span>
<span class="line"><span style="color: #E06C75">    preempted </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦‚æœå½“å‰Continuationå®ä¾‹çš„yieldInfoä¸ç­‰äºä¼ å…¥çš„ContinuationScopeå®ä¾‹ï¼Œåˆ™è¿›è¡Œæ›´æ–°ï¼Œç›¸ç­‰çš„æƒ…å†µä¸‹yieldInfoä¼šä¿æŒæ˜¯ä¸€ä¸ªç©ºå€¼</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (scope </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scope</span><span style="color: #E06C75">)</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">yieldInfo</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> scope</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// æœ€ç»ˆçš„yieldè°ƒç”¨ï¼Œæœ€ç»ˆå½“å‰Continuationå°±æ˜¯é˜»å¡åœ¨æ­¤æ–¹æ³•ï¼Œä»ä¸‹æ–‡æºç çŒœæµ‹ï¼Œå½“è¯¥æ–¹æ³•å”¤é†’åï¼Œreså€¼ä¸º0çš„æ—¶å€™ï¼Œå½“å‰Continuationå®ä¾‹ä¼šç»§ç»­æ‰§è¡Œï¼Œè¿”å›å…¶ä»–å€¼çš„æ—¶å€™åˆ™ä¼šæ‰“å°pinedçº¿ç¨‹æ ˆ</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> res </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">doYield</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// æ”¾ç½®å†…å­˜å±éšœé˜²æ­¢æŒ‡ä»¤é‡æ’ï¼Œåé¢æ³¨é‡Šæåˆ°æ˜¯é˜²æ­¢ç¼–è¯‘å™¨è¿›è¡ŒæŸäº›è½¬æ¢</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">U</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">storeFence</span><span style="color: #ABB2BF">();</span><span style="color: #E06C75"> </span><span style="color: #7F848E; font-style: italic">// needed to prevent certain transformations by the compiler</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> scope </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scope</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">||</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75"> </span><span style="color: #ABB2BF">:</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;scope: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> scope </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot; this.scope: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scope</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot; yieldInfo: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot; res: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> res</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">||</span><span style="color: #E06C75"> scope </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scope</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">||</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #C678DD">instanceof</span><span style="color: #E06C75"> Integer </span><span style="color: #ABB2BF">:</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot;scope: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> scope </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot; this.scope: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scope</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot; yieldInfo: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> </span><span style="color: #98C379">&quot; res: &quot;</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> res</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (child </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123; </span><span style="color: #7F848E; font-style: italic">// TODO: ugly &lt;----- è¿™ä¸ªä½ç½®è¿˜æœ‰ä¸€å¥åæ§½çš„ä»£ç æ³¨é‡Šï¼šä¸‘é™‹çš„ä»£ç </span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (res </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">child</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">yieldInfo</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> res</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (yieldInfo </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #C678DD">instanceof</span><span style="color: #E06C75"> Integer</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">child</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">yieldInfo</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> yieldInfo</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">child</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">yieldInfo</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> res</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">yieldInfo</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (res </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            res </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> (Integer)yieldInfo</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">yieldInfo</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (res </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75">)</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// Continuationå®ä¾‹ç»§ç»­æ‰§è¡Œå‰å›è°ƒ</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">onContinue</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">else</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// Continuationå›ºå®šåœ¨è¿è½½çº¿ç¨‹å‰å›è°ƒï¼Œresæ˜¯pinedçš„çº§åˆ«</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">onPinned0</span><span style="color: #E06C75">(res)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> yieldInfo </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// è¿”å›å¸ƒå°”å€¼ç»“æœè¡¨ç¤ºå½“å‰Continuationå®ä¾‹æ˜¯å¦ä¼šç»§ç»­æ‰§è¡Œ</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> res </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æœ€ç»ˆçš„yieldè°ƒç”¨ï¼Œçœ‹å®ç°æ˜¯æŠ›å‡ºå¼‚å¸¸ï¼ŒçŒœæµ‹æ˜¯ç”±JVMå®ç°</span></span>
<span class="line"><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">IntrinsicCandidate</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">doYield</span><span style="color: #E06C75">() &#123; </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">Error</span><span style="color: #E06C75">(</span><span style="color: #98C379">&quot;Intrinsic not installed&quot;</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75"> &#125;</span></span></code></pre></div><p>è¯´å®è¯ï¼Œ<code>Continuation</code>æºç çš„å¯è¯»æ€§æ¯”æƒ³è±¡ä¸­ä½ï¼Œè¿ä»£ç æ³¨é‡Šä¹Ÿç•™ä¸‹äº†â€ä¸‘é™‹çš„â€è¿™å¥åæ§½ã€‚é€šè¿‡ä¸Šé¢æºç åˆ†æå’Œä¸Šä¸€èŠ‚<code>Continuation</code>çš„ä¸€ä¸ªä¾‹å­ï¼Œå¯ä»¥å¾—çŸ¥<code>Continuation#yield()</code>å¯ä»¥è®©ç¨‹åºä»£ç ä¸­æ–­ï¼Œç„¶åå†æ¬¡è°ƒç”¨<code>Continuation#run()</code>å¯ä»¥ä»ä¸Šä¸€ä¸ªä¸­æ–­ä½ç½®ç»§ç»­æ‰§è¡Œï¼Œ<code>JVM</code>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸ºä½¿ç”¨è€…å±è”½äº†<code>Continuation</code>å’Œè¿è¡Œæ­¤<code>Continuation</code>çš„å¹³å°çº¿ç¨‹ä¹‹é—´çš„äº¤äº’ç»†èŠ‚ï¼Œè®©ä½¿ç”¨è€…å¯ä»¥ä¸“æ³¨å®é™…çš„ä»»åŠ¡å¼€å‘å³å¯ã€‚</p>
<h3 id="VirtualThread"><a href="#VirtualThread" class="headerlink" title="VirtualThread"></a>VirtualThread</h3><p>å‰é¢èŠ±äº†ä¸å°‘ç¯‡å¹…ä»‹ç»<code>Continuation</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…¨æ–°çš„<code>API</code>ã€‚å·²æœ‰çš„<code>JUC</code>ç±»åº“å·²ç»ååˆ†å®Œå–„ï¼Œå¦‚æœå¯ä»¥æŠŠ<code>Continuation</code>èå…¥åˆ°å·²æœ‰çš„<code>JUC</code>ä½“ç³»ï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡çº¿ç¨‹æ± æŠ€æœ¯å»ç®¡ç†è¿è½½çº¿ç¨‹ï¼ŒåŸæœ‰çš„å¤§å¤šæ•°å¹¶å‘ç›¸å…³<code>API</code>ä¹Ÿèƒ½ç›´æ¥åœ¨åç¨‹ä½“ç³»ä¸­ä½¿ç”¨ã€‚ä»è¿™ä¸ªèƒŒæ™¯æ¥çœ‹ï¼Œåˆ›é€ ä¸€ä¸ª<code>Thread</code>ç±»çš„å…¨æ–°å­ç±»ç”¨äºèåˆ<code>JUC</code>å’Œ<code>Continuation</code>æ˜¯ååˆ†åˆé€‚çš„ï¼Œè¿™æ ·é€šè¿‡å¾ˆå°çš„æ”¹é€ æˆæœ¬å°±èƒ½é€šè¿‡<code>Java</code>ç»§æ‰¿ç‰¹æ€§æŠŠè¿™ä¸ªå…¨æ–°å­ç±»é€‚é…<code>JUC</code>ä½“ç³»ï¼Œä¹Ÿèƒ½æ‰©å±•ä¸€äº›<code>API</code>è®©å®ƒé€‚é…åç¨‹æ–°å¼•å…¥çš„ç‰¹æ€§ï¼Œè¿™ä¸ªå…¨æ–°çš„å­ç±»å°±æ˜¯<code>java.lang.VirtualThread</code>ï¼š</p>
<p><img src="https://cdn.vlts.cn/202210/vt-source-code-12.webp" alt="vt-source-code-12"></p>
<p><code>VirtualThread</code>ç±»çš„ç»§æ‰¿ä½“ç³»å¦‚ä¸‹ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #C678DD">package</span><span style="color: #E06C75"> </span><span style="color: #C678DD">java.lang</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">class</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">VirtualThread</span><span style="color: #E06C75"> </span><span style="color: #C678DD">extends</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">BaseVirtualThread</span><span style="color: #E06C75"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #E06C75">  </span><span style="color: #7F848E; font-style: italic">// ...</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">package</span><span style="color: #E06C75"> </span><span style="color: #C678DD">java.lang</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">sealed</span><span style="color: #E06C75"> </span><span style="color: #C678DD">abstract</span><span style="color: #E06C75"> </span><span style="color: #C678DD">class</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">BaseVirtualThread</span><span style="color: #E06C75"> </span><span style="color: #C678DD">extends</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">permits</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">VirtualThread</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ThreadBuilders</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">BoundVirtualThread</span><span style="color: #E06C75"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #E06C75">  </span><span style="color: #7F848E; font-style: italic">// ...</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span></code></pre></div><p><code>VirtualThread</code>æ˜¯<code>BaseVirtualThread</code>çš„å­ç±»ï¼Œè€Œ<code>BaseVirtualThread</code>æ˜¯ä¸€ä¸ªâ€å¯†å°ç±»â€ï¼Œå®ƒæ˜¯<code>Thread</code>çš„å­ç±»ï¼Œåªå¯¹<code>VirtualThread</code>å’Œ<code>ThreadBuilders.BoundVirtualThread</code>å¼€æ”¾ï¼Œå¹¶ä¸”<code>VirtualThread</code>æ˜¯<strong>åŒ…ç§æœ‰è®¿é—®æƒé™çš„</strong>åŒæ—¶ç”¨<code>final</code>å…³é”®å­—ä¿®é¥°ï¼Œæ— æ³•è¢«ç»§æ‰¿ã€‚æ¥ç€çœ‹<code>VirtualThread</code>çš„æˆå‘˜å˜é‡å’Œæ„é€ å‡½æ•°ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// java.lang.VirtualThread</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Unsafeå®ä¾‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Unsafe</span><span style="color: #E06C75"> U </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Unsafe</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getUnsafe</span><span style="color: #ABB2BF">();</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è™šæ‹Ÿçº¿ç¨‹çš„ContinuationScopeé™æ€å¸¸é‡</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ContinuationScope</span><span style="color: #E06C75"> VTHREAD_SCOPE </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">ContinuationScope</span><span style="color: #E06C75">(</span><span style="color: #98C379">&quot;VirtualThreads&quot;</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è°ƒåº¦å™¨ï¼Œæˆ–è€…è¯´æ‰§è¡Œå™¨ï¼Œé»˜è®¤å°±æ˜¯ç”¨æ­¤è°ƒåº¦å™¨è¿è¡Œè™šæ‹Ÿçº¿ç¨‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ForkJoinPool</span><span style="color: #E06C75"> DEFAULT_SCHEDULER </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">createDefaultScheduler</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è°ƒåº¦çº¿ç¨‹æ± å®ä¾‹ï¼Œç”¨äºå”¤é†’å¸¦è¶…æ—¶é˜»å¡çš„è™šæ‹Ÿçº¿ç¨‹å®ä¾‹ï¼Œä¸»è¦ç”¨äºsleepçš„å”¤é†’</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ScheduledExecutorService</span><span style="color: #E06C75"> UNPARKER </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">createDelayedTaskScheduler</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// pinæ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯pined threadçš„è·Ÿè¸ªæ¨¡å¼ï¼Œå†³å®šæ‰“å°å †æ ˆçš„è¯¦ç»†ç¨‹åº¦ï¼Œæ¥è‡ªäºç³»ç»Ÿå‚æ•°jdk.tracePinnedThreadsï¼Œfullè¡¨ç¤ºè¯¦ç»†ï¼Œshortè¡¨ç¤ºç®€ç•¥</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> TRACE_PINNING_MODE </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">tracePinningMode</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// ä¸‹é¢å‡ ä¸ªéƒ½æ˜¯æˆå‘˜åœ°å€ï¼Œç”¨äºUnsafeç›´æ¥æ“ä½œæˆå‘˜</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> STATE </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">U</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">objectFieldOffset</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">VirtualThread</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">class</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;state&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> PARK_PERMIT </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">U</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">objectFieldOffset</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">VirtualThread</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">class</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;parkPermit&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> CARRIER_THREAD </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">U</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">objectFieldOffset</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">VirtualThread</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">class</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;carrierThread&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> TERMINATION </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">U</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">objectFieldOffset</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">VirtualThread</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">class</span><span style="color: #ABB2BF">, </span><span style="color: #98C379">&quot;termination&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è°ƒåº¦å™¨å®ä¾‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Executor</span><span style="color: #E06C75"> scheduler</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuationå®ä¾‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> cont</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuationå®ä¾‹çš„RunnableåŒ…è£…å®ä¾‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Runnable</span><span style="color: #E06C75"> runContinuation</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è™šæ‹Ÿçº¿ç¨‹çŠ¶æ€ï¼Œè¿™ä¸ªå€¼ç”±JVMè®¿é—®å’Œä¿®æ”¹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">volatile</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> state</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// ä¸‹é¢çš„çŠ¶æ€é›†åˆ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> NEW      </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> STARTED  </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> RUNNABLE </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75">     </span><span style="color: #7F848E; font-style: italic">// runnable-unmounted</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> RUNNING  </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">3</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75">     </span><span style="color: #7F848E; font-style: italic">// runnable-mounted</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> PARKING  </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">4</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> PARKED   </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">5</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75">     </span><span style="color: #7F848E; font-style: italic">// unmounted</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> PINNED   </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">6</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75">     </span><span style="color: #7F848E; font-style: italic">// mounted</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> YIELDING </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">7</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75">     </span><span style="color: #7F848E; font-style: italic">// Thread.yield</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> TERMINATED </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">99</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75">  </span><span style="color: #7F848E; font-style: italic">// final state</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è™šæ‹Ÿçº¿ç¨‹unmountåå¯ä»¥ä»è°ƒåº¦è¿‡ç¨‹ä¸­æŒ‚èµ·çš„çŠ¶æ€</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> SUSPENDED </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">1</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">&lt;&lt;</span><span style="color: #E06C75"> </span><span style="color: #D19A66">8</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> RUNNABLE_SUSPENDED </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> (RUNNABLE </span><span style="color: #56B6C2">|</span><span style="color: #E06C75"> SUSPENDED)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> PARKED_SUSPENDED   </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> (PARKED </span><span style="color: #56B6C2">|</span><span style="color: #E06C75"> SUSPENDED)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// parkæ“ä½œè®¸å¯</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">volatile</span><span style="color: #E06C75"> </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> parkPermit</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è¿è½½çº¿ç¨‹å®ä¾‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">volatile</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span><span style="color: #E06C75"> carrierThread</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// ç»ˆç»“å€’æ•°æ …æ å®ä¾‹ï¼Œä¸»è¦ç”¨äºjoinæ“ä½œ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">volatile</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">CountDownLatch</span><span style="color: #E06C75"> termination</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// å”¯ä¸€æ„é€ å‡½æ•°</span></span>
<span class="line"><span style="color: #61AFEF">VirtualThread</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">Executor</span><span style="color: #E06C75"> scheduler</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">String</span><span style="color: #E06C75"> name</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> characteristics</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Runnable</span><span style="color: #E06C75"> task) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// é»˜è®¤æ ‡è®°boundä¸ºfalseï¼Œå½“boundä¸ºtrueçš„æ—¶å€™æ ‡è®°ä¸ºç»‘å®šåˆ°ç³»ç»Ÿçº¿ç¨‹</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">super</span><span style="color: #E06C75">(name</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> characteristics</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #7F848E; font-style: italic">/*bound*/</span><span style="color: #E06C75"> </span><span style="color: #D19A66">false</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">Objects</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">requireNonNull</span><span style="color: #ABB2BF">(task);</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦‚æœä¼ å…¥çš„è°ƒåº¦å™¨å®ä¾‹éç©ºåˆ™ç›´æ¥ä½¿ç”¨</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦åˆ™ï¼Œå¦‚æœçˆ¶çº¿ç¨‹æ˜¯è™šæ‹Ÿçº¿ç¨‹ï¼Œåˆ™ä½¿ç”¨çˆ¶è™šæ‹Ÿçº¿ç¨‹çš„è°ƒåº¦å™¨å®ä¾‹</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦‚æœä¼ å…¥çš„è°ƒåº¦å™¨å®ä¾‹ä¸ºç©ºï¼Œçˆ¶çº¿ç¨‹ä¸ºå¹³å°çº¿ç¨‹ï¼Œé‚£ä¹ˆä½¿ç”¨é»˜è®¤çš„è°ƒåº¦å™¨</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// choose scheduler if not specified</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (scheduler </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">Thread</span><span style="color: #E06C75"> parent </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">currentThread</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (parent </span><span style="color: #C678DD">instanceof</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">VirtualThread</span><span style="color: #E06C75"> vparent) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            scheduler </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">vparent</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scheduler</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            scheduler </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> DEFAULT_SCHEDULER</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// èµ‹å€¼è°ƒåº¦å™¨</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">scheduler</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> scheduler</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å°è£…å’Œåˆå§‹åŒ–Continuation</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">cont</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">VThreadContinuation</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> task)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// åˆå§‹åŒ–Continuationçš„RunnableåŒ…è£…å™¨ï¼Œæœ€ç»ˆæäº¤åˆ°è°ƒåº¦å™¨ä¸­æ‰§è¡Œ</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">runContinuation</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #C678DD">::</span><span style="color: #E06C75">runContinuation</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è™šæ‹Ÿçº¿ç¨‹Continuationçš„ä¸“æœ‰å­ç±»ï¼Œé»˜è®¤ä¸ºContinuationScope(&quot;VirtualThreads&quot;)ï¼Œä»è€Œå®ç°Continuation.enter()æ‰§è¡Œæ—¶å€™å®é™…ä¸Šæ‰§è¡Œçš„æ˜¯VirtualThread.run()æ–¹æ³•</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// ä¹Ÿå°±æ˜¯ Runnable.run()[runContinuation by carrier thread from executor] --&gt; Continuation.run() --&gt; Continuation.enter() --&gt; VirtualThread.run() --&gt; Runnable.run()[user task]</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">class</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">VThreadContinuation</span><span style="color: #E06C75"> </span><span style="color: #C678DD">extends</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Continuation</span><span style="color: #E06C75"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #61AFEF">VThreadContinuation</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">VirtualThread</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">vthread</span><span style="color: #ABB2BF">, </span><span style="color: #E5C07B">Runnable</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">task</span><span style="color: #ABB2BF">)</span><span style="color: #61AFEF"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #E5C07B">super</span><span style="color: #ABB2BF">(VTHREAD_SCOPE, () </span><span style="color: #C678DD">-&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">vthread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">(task));</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// pinä¹‹å‰å›è°ƒçš„æ–¹æ³•ï¼ŒåŸºäºTRACE_PINNING_MODEçš„è¿”å›å€¼å†³å®špinnedçº¿ç¨‹æ ˆçš„æ‰“å°è¯¦ç•¥</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">Override</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">protected</span><span style="color: #61AFEF"> </span><span style="color: #C678DD">void</span><span style="color: #61AFEF"> onPinned</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">Continuation</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">Pinned</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75; font-style: italic">reason</span><span style="color: #ABB2BF">)</span><span style="color: #61AFEF"> </span><span style="color: #ABB2BF">&#123;</span></span>
<span class="line"><span style="color: #ABB2BF">        </span><span style="color: #C678DD">if</span><span style="color: #ABB2BF"> (TRACE_PINNING_MODE </span><span style="color: #56B6C2">&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">) &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">boolean</span><span style="color: #ABB2BF"> </span><span style="color: #E06C75">printAll</span><span style="color: #ABB2BF"> </span><span style="color: #56B6C2">=</span><span style="color: #ABB2BF"> (TRACE_PINNING_MODE </span><span style="color: #56B6C2">==</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #E5C07B">PinnedThreadPrinter</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">printStackTrace</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">out</span><span style="color: #ABB2BF">, printAll);</span></span>
<span class="line"><span style="color: #ABB2BF">        &#125;</span></span>
<span class="line"><span style="color: #ABB2BF">    &#125;</span></span>
<span class="line"><span style="color: #ABB2BF">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// åœ¨å½“å‰çº¿ç¨‹ä¸Šè¿è¡Œæˆ–ç»§ç»­Continuationçš„æ‰§è¡Œï¼Œå¿…é¡»ç”±å¹³å°çº¿ç¨‹è¿è¡Œæ­¤æ–¹æ³•ï¼Œæœ€ç»ˆä¼šå°è£…ä¸ºRunnbleåŒ…è£…å™¨æäº¤åˆ°æ‰§è¡Œå™¨ä¸­è¿è¡Œ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">runContinuation</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// the carrier must be a platform thread</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">currentThread</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">isVirtual</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">WrongThreadException</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// set state to RUNNING</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> firstRun</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> initialState </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">state</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å½“å‰ä¸ºSTARTEDçŠ¶æ€å¹¶ä¸”CASæ›´æ–°ä¸ºRUNNINGçŠ¶æ€åˆ™æ ‡è®°é¦–æ¬¡è¿è¡Œä¸ºtrue</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (initialState </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> STARTED </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">compareAndSetState</span><span style="color: #E06C75">(STARTED</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> RUNNING)) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// first run</span></span>
<span class="line"><span style="color: #E06C75">        firstRun </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (initialState </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> RUNNABLE </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">compareAndSetState</span><span style="color: #E06C75">(RUNNABLE</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> RUNNING)) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// å½“å‰ä¸ºRUNNABLEçŠ¶æ€å¹¶ä¸”CASæ›´æ–°ä¸ºRUNNINGçŠ¶æ€åˆ™æ ‡è®°é¦–æ¬¡è¿è¡Œä¸ºfalseï¼Œå¹¶ä¸”è®¾ç½®parkè®¸å¯ä¸ºfalse</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// consume parking permit</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">setParkPermit</span><span style="color: #E06C75">(</span><span style="color: #D19A66">false</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        firstRun </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// not runnable</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// notify JVMTI before mount</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (notifyJvmtiEvents) </span><span style="color: #61AFEF">notifyJvmtiMountBegin</span><span style="color: #E06C75">(firstRun)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// æ‰§è¡ŒContinuation.run()</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">cont</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">run</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// Continuationæ‰§è¡Œå®Œæˆï¼Œå›è°ƒé’©å­æ–¹æ³•afterTerminate</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #E5C07B">cont</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">isDone</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">afterTerminate</span><span style="color: #E06C75">(</span><span style="color: #7F848E; font-style: italic">/*executed*/</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// Continuationæ²¡æœ‰æ‰§è¡Œå®Œæˆï¼Œè¯´æ˜è°ƒç”¨äº†Continuation.yieldæˆ–è€…pinåˆ°è¿è½½çº¿ç¨‹ä¸­è¿›è¡Œäº†parkæ“ä½œ</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">afterYield</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Continuationæ‰§è¡Œå®Œæˆå›è°ƒçš„é’©å­æ–¹æ³•</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">afterTerminate</span><span style="color: #E06C75">(</span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> executed) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> (</span><span style="color: #61AFEF">state</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> TERMINATED) </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> (carrierThread </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (executed) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (notifyJvmtiEvents) </span><span style="color: #61AFEF">notifyJvmtiUnmountEnd</span><span style="color: #E06C75">(</span><span style="color: #D19A66">true</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹é˜»å¡ç­‰å¾…è™šæ‹Ÿçº¿ç¨‹çš„è¿”å›ï¼Œä¾‹å¦‚è°ƒç”¨äº†joinæ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œè§£é™¤é˜»å¡</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">CountDownLatch</span><span style="color: #E06C75"> termination </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">termination</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (termination </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">termination</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getCount</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">termination</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">countDown</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦‚æœæ‰§è¡ŒæˆåŠŸåˆ™é€šçŸ¥çº¿ç¨‹å®¹å™¨å½“å‰çº¿ç¨‹å®ä¾‹é€€å‡ºï¼Œæ¸…ç©ºçº¿ç¨‹æœ¬åœ°å˜é‡å¼•ç”¨</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (executed) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// notify container if thread executed</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">threadContainer</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">onExit</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// clear references to thread locals</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">clearReferences</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// ç”±äºContinuationçš„yieldæ“ä½œæˆ–è€…è°ƒç”¨äº†Thread.yield()å¯¼è‡´ContinuationæŒ‚èµ·ï¼Œéœ€è¦é‡æ–°æŠŠContinuationçš„åŒ…è£…å™¨&quot;æ‡’æäº¤&quot;åˆ°è°ƒåº¦å™¨ä¸­</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">afterYield</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> s </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">state</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> (s </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> PARKING </span><span style="color: #56B6C2">||</span><span style="color: #E06C75"> s </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> YIELDING) </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> (carrierThread </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦‚æœæ˜¯PARKINGçŠ¶æ€ï¼Œè¿™ç§å¯¹åº”äºContinuationçš„yieldæ“ä½œè°ƒç”¨</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (s </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> PARKING) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// æ›´å˜ä¸ºPARKEDçŠ¶æ€</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">setState</span><span style="color: #E06C75">(PARKED)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// notify JVMTI that unmount has completed, thread is parked</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (notifyJvmtiEvents) </span><span style="color: #61AFEF">notifyJvmtiUnmountEnd</span><span style="color: #E06C75">(</span><span style="color: #D19A66">false</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// å¾—åˆ°parkè®¸å¯ï¼Œå¹¶ä¸”CASä¸ºRUNNABLEçŠ¶æ€</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (parkPermit </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">compareAndSetState</span><span style="color: #E06C75">(PARKED</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> RUNNABLE)) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// è¿›è¡Œæ‡’æäº¤ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œç”¨å½“å‰çº¿ç¨‹ä½œä¸ºè¿è½½çº¿ç¨‹ç»§ç»­æ‰§è¡Œä»»åŠ¡</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">lazySubmitRunContinuation</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (s </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> YIELDING) &#123;   </span><span style="color: #7F848E; font-style: italic">// å¦‚æœæ˜¯YIELDINGçŠ¶æ€ï¼Œè¿™ç§å¯¹åº”äºè°ƒç”¨äº†Thread.yield</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// æ›´å˜ä¸ºRUNNABLEçŠ¶æ€</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">setState</span><span style="color: #E06C75">(RUNNABLE)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// notify JVMTI that unmount has completed, thread is runnable</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (notifyJvmtiEvents) </span><span style="color: #61AFEF">notifyJvmtiUnmountEnd</span><span style="color: #E06C75">(</span><span style="color: #D19A66">false</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// è¿›è¡Œæ‡’æäº¤ï¼Œå¦‚æœå¯èƒ½çš„è¯ï¼Œç”¨å½“å‰çº¿ç¨‹ä½œä¸ºè¿è½½çº¿ç¨‹ç»§ç»­æ‰§è¡Œä»»</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">lazySubmitRunContinuation</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span></code></pre></div><p>è¿™é‡Œå”¯ä¸€çš„æ„é€ å‡½æ•°æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼ŒæŠ›å¼€ä¸€äº›é’©å­æ¥å£ï¼Œæœ€ç»ˆæƒ³è¾¾åˆ°çš„æ•ˆæœå°±æ˜¯ï¼š</p>
<div class="language-shell"><button title="Copy code" class="copy"></button><span class="lang">shell</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #61AFEF">Runnable.run</span><span style="color: #ABB2BF">()[runContinuation by carrier thread from executor] --&gt; </span><span style="color: #61AFEF">Continuation.run</span><span style="color: #ABB2BF">() --&gt; Continuation.enter() --&gt; </span><span style="color: #61AFEF">VirtualThread.run</span><span style="color: #ABB2BF">() --&gt; Runnable.run()[user task]</span></span></code></pre></div><p>ç”¨æˆ·ä»»åŠ¡å®é™…è¢«åŒ…è£¹äº†å¾ˆå¤šå±‚ï¼Œåœ¨æœ€é‡Œé¢ä¸€å±‚æ‰ä¼šå›è°ƒã€‚<code>VirtualThread</code>ä¸­æä¾›äº†ä¸¤ä¸ªé™æ€å…¨å±€çš„çº¿ç¨‹æ± å®ä¾‹ï¼Œä¸€ä¸ªç”¨äºè°ƒåº¦ï¼Œä¸€ä¸ªç”¨äºå”¤é†’ï¼Œè¿™é‡Œçœ‹çœ‹ä¸¤ä¸ªçº¿ç¨‹æ± æ˜¯å¦‚ä½•æ„é€ çš„ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// java.lang.VirtualThread</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ForkJoinPool</span><span style="color: #E06C75"> DEFAULT_SCHEDULER </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">createDefaultScheduler</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #C678DD">final</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ScheduledExecutorService</span><span style="color: #E06C75"> UNPARKER </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">createDelayedTaskScheduler</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// åˆ›å»ºé»˜è®¤çš„è°ƒåº¦å™¨</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ForkJoinPool</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">createDefaultScheduler</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// çº¿ç¨‹å·¥å‚ï¼Œé»˜è®¤åˆ›å»ºCarrierThreadå®ä¾‹ï¼ŒCarrierThreadæ˜¯ForkJoinWorkerThreadçš„ä¸€ä¸ªå­ç±»</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">ForkJoinWorkerThreadFactory</span><span style="color: #E06C75"> factory </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> pool </span><span style="color: #C678DD">-&gt;</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">PrivilegedAction</span><span style="color: #ABB2BF">&lt;</span><span style="color: #E5C07B">ForkJoinWorkerThread</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75"> pa </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> () </span><span style="color: #C678DD">-&gt;</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">CarrierThread</span><span style="color: #E06C75">(pool)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">AccessController</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">doPrivileged</span><span style="color: #ABB2BF">(pa);</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">PrivilegedAction</span><span style="color: #ABB2BF">&lt;</span><span style="color: #E5C07B">ForkJoinPool</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75"> pa </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> () </span><span style="color: #C678DD">-&gt;</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> parallelism</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> maxPoolSize</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> minRunnable</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">String</span><span style="color: #E06C75"> parallelismValue </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getProperty</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;jdk.virtualThreadScheduler.parallelism&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">String</span><span style="color: #E06C75"> maxPoolSizeValue </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getProperty</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;jdk.virtualThreadScheduler.maxPoolSize&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">String</span><span style="color: #E06C75"> minRunnableValue </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getProperty</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;jdk.virtualThreadScheduler.minRunnable&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (parallelismValue </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            parallelism </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Integer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parseInt</span><span style="color: #ABB2BF">(parallelismValue);</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            parallelism </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Runtime</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getRuntime</span><span style="color: #ABB2BF">().</span><span style="color: #61AFEF">availableProcessors</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (maxPoolSizeValue </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            maxPoolSize </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Integer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parseInt</span><span style="color: #ABB2BF">(maxPoolSizeValue);</span></span>
<span class="line"><span style="color: #E06C75">            parallelism </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Integer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">min</span><span style="color: #ABB2BF">(parallelism, maxPoolSize);</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            maxPoolSize </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Integer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">max</span><span style="color: #ABB2BF">(parallelism, </span><span style="color: #D19A66">256</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (minRunnableValue </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            minRunnable </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Integer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parseInt</span><span style="color: #ABB2BF">(minRunnableValue);</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            minRunnable </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Integer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">max</span><span style="color: #ABB2BF">(parallelism </span><span style="color: #56B6C2">/</span><span style="color: #ABB2BF"> </span><span style="color: #D19A66">2</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">UncaughtExceptionHandler</span><span style="color: #E06C75"> handler </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> (t</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> e) </span><span style="color: #C678DD">-&gt;</span><span style="color: #E06C75"> &#123; &#125;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> asyncMode </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span><span style="color: #E06C75"> </span><span style="color: #7F848E; font-style: italic">// FIFO</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">ForkJoinPool</span><span style="color: #E06C75">(parallelism</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> factory</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> handler</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> asyncMode</span><span style="color: #ABB2BF">,</span></span>
<span class="line"><span style="color: #E06C75">                        </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> maxPoolSize</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> minRunnable</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> pool </span><span style="color: #C678DD">-&gt;</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #D19A66">30</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> SECONDS)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">AccessController</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">doPrivileged</span><span style="color: #ABB2BF">(pa);</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// åˆ›å»ºè°ƒåº¦çº¿ç¨‹æ± ï¼Œç”¨äºè™šæ‹Ÿçº¿ç¨‹å¸¦è¶…æ—¶æ—¶é—´çš„unparkæ“ä½œ</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">static</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ScheduledExecutorService</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">createDelayedTaskScheduler</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">String</span><span style="color: #E06C75"> propValue </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">GetPropertyAction</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">privilegedGetProperty</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;jdk.unparker.maxPoolSize&quot;</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">int</span><span style="color: #E06C75"> poolSize</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (propValue </span><span style="color: #56B6C2">!=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        poolSize </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Integer</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">parseInt</span><span style="color: #ABB2BF">(propValue);</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// ç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹</span></span>
<span class="line"><span style="color: #E06C75">        poolSize </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">1</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">ScheduledThreadPoolExecutor</span><span style="color: #E06C75"> stpe </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> (ScheduledThreadPoolExecutor)</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">Executors</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">newScheduledThreadPool</span><span style="color: #ABB2BF">(poolSize, task </span><span style="color: #C678DD">-&gt;</span><span style="color: #ABB2BF"> &#123;</span></span>
<span class="line"><span style="color: #ABB2BF">            </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF"> </span><span style="color: #E5C07B">InnocuousThread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">newThread</span><span style="color: #ABB2BF">(</span><span style="color: #98C379">&quot;VirtualThread-unparker&quot;</span><span style="color: #ABB2BF">, task);</span></span>
<span class="line"><span style="color: #ABB2BF">        &#125;);</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// ä»»åŠ¡å–æ¶ˆåé©¬ä¸Šä»å·¥ä½œé˜Ÿåˆ—ç§»é™¤</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">stpe</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">setRemoveOnCancelPolicy</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> stpe</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span></code></pre></div><p>å¯¹äºé»˜è®¤è°ƒåº¦å™¨ï¼ˆ<code>DEFAULT_SCHEDULER</code>ï¼‰çš„åˆ›å»ºï¼Œå®ƒæ˜¯ä¸€ä¸ª<code>ForkJoinPool</code>å®ä¾‹ï¼Œæ„é€ å‚æ•°çš„é€‰å–å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>parallelism</code>å‚æ•°ç”±ç³»ç»Ÿå˜é‡<code>jdk.virtualThreadScheduler.parallelism</code>å†³å®šï¼Œé»˜è®¤å€¼ä¸º<code>Runtime.getRuntime().availableProcessors()</code>ï¼Œå¦‚æœé…ç½®äº†ç³»ç»Ÿå‚æ•°<code>jdk.virtualThreadScheduler.maxPoolSize</code>åˆ™å–<code>min(parallelism,maxPoolSize)</code></li>
<li><code>maxPoolSize</code>å‚æ•°ç”±ç³»ç»Ÿå˜é‡<code>jdk.virtualThreadScheduler.maxPoolSize</code>å†³å®šï¼Œé»˜è®¤å€¼ä¸º<code>min(parallelism, maxPoolSize)</code></li>
<li><code>minRunnable</code>å‚æ•°ç”±ç³»ç»Ÿå˜é‡<code>jdk.virtualThreadScheduler.minRunnable</code>å†³å®šï¼Œé»˜è®¤å€¼ä¸º<code>max(parallelism / 2, 1)</code></li>
<li><code>asyncMode</code>å‚æ•°å›ºå®šå€¼<code>true</code>ï¼Œä¹Ÿå°±æ˜¯é€‰ç”¨<code>FIFO</code>æ¨¡å¼</li>
<li><code>keepAliveTime</code>å‚æ•°ä¸ºå›ºå®šå€¼<code>30</code>ç§’</li>
<li><code>saturate</code>å‚æ•°åœ¨<code>JDK17</code>å¼•å…¥ï¼Œæ˜¯ä¸€ä¸ª<code>Predicate</code>å‡½æ•°ï¼Œåœ¨æ­¤å›ºå®šè¿”å›<code>true</code>ï¼Œç”¨äºå¿½ç•¥<code>minRunnable</code>å€¼å…è®¸çº¿ç¨‹æ± é¥±å’Œ</li>
<li>çº¿ç¨‹å·¥å‚ç”¨äºåˆ›å»º<code>CarrierThread</code>å®ä¾‹ï¼Œ<code>CarrierThread</code>æ˜¯<code>ForkJoinWorkerThread</code>çš„å­ç±»</li>
</ul>
<p>åœ¨<code>Intel 4C8T</code>å¼€å‘æœºå™¨ç¯å¢ƒä¸­ï¼Œè¯¥<code>ForkJoinPool</code>å®ä¾‹åˆ›å»ºæ—¶å€™çš„å‡ ä¸ªå‚æ•°åˆ†åˆ«ä¸ºï¼š<code>parallelism = 8, maxPoolSize = 256, minRunnable = 4</code>ã€‚</p>
<p>å¯¹äºè°ƒåº¦çº¿ç¨‹æ± ï¼ˆ<code>UNPARKER</code>ï¼‰çš„åˆ›å»ºï¼Œå®ƒæ˜¯ä¸€ä¸ª<code>ScheduledThreadPoolExecutor</code>å®ä¾‹ï¼Œæ„é€ å‚æ•°çš„é€‰å–å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>corePoolSize</code>å‚æ•°ç”±ç³»ç»Ÿå˜é‡<code>jdk.unparker.maxPoolSize</code>å†³å®šï¼Œå¹¶ä¸”ç¡®ä¿æœ€å°å€¼ä¸º<code>1</code></li>
<li>çº¿ç¨‹å·¥å‚ç”¨äºåˆ›å»º<code>InnocuousThread</code>å®ä¾‹ï¼Œçº¿ç¨‹åç§°ä¸º<code>VirtualThread-unparker</code></li>
</ul>
<p>æ¥ç€çœ‹è™šæ‹Ÿçº¿ç¨‹çš„å¯åŠ¨æ–¹æ³•<code>start()</code>ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// java.lang.VirtualThread</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">Override</span></span>
<span class="line"><span style="color: #C678DD">public</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">start</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #61AFEF">start</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">ThreadContainers</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">root</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è°ƒåº¦è™šæ‹Ÿçº¿ç¨‹è®©ä¹‹è¿è¡Œ</span></span>
<span class="line"><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">Override</span></span>
<span class="line"><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">start</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">ThreadContainer</span><span style="color: #E06C75"> container) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// CASç”±NEWè½¬æ¢ä¸ºSTARTEDçŠ¶æ€</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #61AFEF">compareAndSetState</span><span style="color: #E06C75">(NEW</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> STARTED)) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">IllegalThreadStateException</span><span style="color: #E06C75">(</span><span style="color: #98C379">&quot;Already started&quot;</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// ç»‘å®šå½“å‰è™šæ‹Ÿçº¿ç¨‹åˆ°çº¿ç¨‹å®¹å™¨</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #61AFEF">setThreadContainer</span><span style="color: #E06C75">(container)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// æ ‡è®°ä¸ºæœªå¯åŠ¨</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> started </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å›è°ƒstarté’©å­æ–¹æ³•</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">container</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">onStart</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">);</span><span style="color: #E06C75"> </span><span style="color: #7F848E; font-style: italic">// may throw</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// ä»ç»™å®šå®¹å™¨ç»§æ‰¿extent-localç»‘å®šå‚æ•°</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">inheritExtentLocalBindings</span><span style="color: #E06C75">(container)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// æäº¤&#39;runContinuation&#39;ä»»åŠ¡åˆ°è°ƒåº¦å™¨</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">submitRunContinuation</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// æ ‡è®°ä¸ºå¯åŠ¨å®Œæˆ</span></span>
<span class="line"><span style="color: #E06C75">        started </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// å¦‚æœå¯åŠ¨å¤±è´¥ï¼Œåˆ™æ ‡è®°æœ€ç»ˆçŠ¶æ€å’Œå›è°ƒç»ˆç»“é’©å­æ–¹æ³•</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #E06C75">started) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">setState</span><span style="color: #E06C75">(TERMINATED)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">container</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">onExit</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">afterTerminate</span><span style="color: #E06C75">(</span><span style="color: #7F848E; font-style: italic">/*executed*/</span><span style="color: #E06C75"> </span><span style="color: #D19A66">false</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æäº¤&#39;runContinuation&#39;ä»»åŠ¡åˆ°è°ƒåº¦å™¨</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">submitRunContinuation</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #61AFEF">submitRunContinuation</span><span style="color: #E06C75">(</span><span style="color: #D19A66">false</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æäº¤&#39;runContinuation&#39;ä»»åŠ¡åˆ°è°ƒåº¦å™¨ï¼ŒlazySubmitå‚æ•°å†³å®šæ˜¯å¦&quot;æ‡’æäº¤&quot;</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">submitRunContinuation</span><span style="color: #E06C75">(</span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> lazySubmit) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (lazySubmit </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> scheduler </span><span style="color: #C678DD">instanceof</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ForkJoinPool</span><span style="color: #E06C75"> pool) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// ForkJoinPoolç±»å‹è°ƒåº¦å™¨å¹¶ä¸”lazySubmitä¸ºtrueï¼Œå¯¹runContinuationè¿™ä¸ªRunnableå®ä¾‹é€‚é…ä¸ºForkJoinTaskç±»å‹ï¼Œè¿›è¡Œ&quot;æ‡’æäº¤&quot;åˆ°ForkJoinPool</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">pool</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">lazySubmit</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">ForkJoinTask</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">adapt</span><span style="color: #ABB2BF">(runContinuation));</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// éForkJoinPoolç±»å‹è°ƒåº¦å™¨æˆ–è€…lazySubmitä¸ºfalseï¼Œç›´æ¥ä½¿ç”¨Executor.execute()æäº¤ä»»åŠ¡</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">scheduler</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">execute</span><span style="color: #ABB2BF">(runContinuation);</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">catch</span><span style="color: #E06C75"> (</span><span style="color: #E5C07B">RejectedExecutionException</span><span style="color: #E06C75"> </span><span style="color: #E06C75; font-style: italic">ree</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// çº¿ç¨‹æ± æ‹’ç»æ¥æ”¶ä»»åŠ¡ï¼Œå‘å¸ƒæäº¤å¤±è´¥äº‹ä»¶åˆ°JVM</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">var</span><span style="color: #E06C75"> event </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">VirtualThreadSubmitFailedEvent</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #E5C07B">event</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">isEnabled</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">event</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">javaThreadId</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">threadId</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">event</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">exceptionMessage</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">ree</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">getMessage</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">event</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">commit</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> ree</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span></code></pre></div><p><code>ForkJoinPool#lazySubmit()</code>æ˜¯<code>JDK19</code>æ–°å¢çš„ä¸€ä¸ª<code>API</code>ï¼Œå®ƒçš„æ–¹æ³•æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote><span class="custom-blockquote-svg"><svg width="24" height="24" viewBox="0 0 24 24" fill="" xmlns="http://www.w3.org/2000/svg" data-reactroot="">
<path fill="" d="M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z" undefined="1"></path>
<path fill="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z" undefined="1"></path>
<path fill="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z" undefined="1"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z"></path>
<path stroke-linejoin="round" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" stroke="" d="M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z"></path>
</svg>
</span><p>æäº¤ç»™å®šçš„ä»»åŠ¡ï¼Œä½†ä¸ä¿è¯å®ƒæœ€ç»ˆä¼šåœ¨æ²¡æœ‰å¯ç”¨æ´»åŠ¨çº¿ç¨‹çš„æƒ…å†µä¸‹æ‰§è¡Œã€‚åœ¨æŸäº›ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥é€šè¿‡ä¾èµ–äºç‰¹å®šäºä¸Šä¸‹æ–‡çš„çŸ¥è¯†æ¥å‡å°‘ç«äº‰å’Œå¼€é”€ï¼Œå³ç°æœ‰çº¿ç¨‹(å¦‚æœåœ¨æ­¤æ± ä¸­æ“ä½œï¼Œåˆ™å¯èƒ½åŒ…æ‹¬è°ƒç”¨çº¿ç¨‹)æœ€ç»ˆå°†å¯ç”¨æ¥æ‰§è¡Œä»»åŠ¡</p></blockquote>
<p>ä½¿ç”¨æ­¤æ–¹æ³•æäº¤çš„ç›®çš„å°±æ˜¯å¸Œæœ›å¯ä»¥ç”¨å½“å‰è°ƒç”¨çº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œå¯¹äºé¦–æ¬¡æäº¤<code>Continuation</code>ä»»åŠ¡å¯èƒ½ä½œç”¨ä¸æ˜æ˜¾ï¼Œä½†æ˜¯å¯¹äº<code>Continuation.yield()</code>è°ƒç”¨åçš„å†æ¬¡æäº¤æ„ä¹‰æ¯”è¾ƒé‡å¤§ï¼Œå› ä¸ºè¿™æ ·å°±å¯ä»¥<strong>æŠŠè¿è¡Œçš„<code>Continuation.run()</code>æ–¹æ³•é“¾åˆ†é…åˆ°åŒä¸€ä¸ªè¿è½½çº¿ç¨‹å®ä¾‹</strong>ï¼Œåœ¨å¼€å‘è€…çš„è§’åº¦å°±æ˜¯è™šæ‹Ÿçº¿ç¨‹ä»»åŠ¡æ‰§è¡Œä¸­æ–­åæ¢å¤æ‰§è¡Œï¼Œæ‰§è¡Œä»»åŠ¡çš„è¿è½½çº¿ç¨‹æ²¡æœ‰æ”¹å˜ã€‚</p>
<p>æºç ä¸­è¿˜å¯ä»¥å‘ç°ï¼Œ<code>run()</code>æ–¹æ³•è¦†ç›–äº†<code>Thread#run()</code>æ›¿æ¢ä¸ºç©ºå®ç°ï¼Œå› ä¸º<code>VirtualThread</code>æœ€ç»ˆæ˜¯è§¦å‘<code>Continuation#run()</code>ï¼Œè¿™ä¸€ç‚¹å·²ç»åœ¨<code>start()</code>æ–¹æ³•è¿›è¡Œæäº¤å’Œè°ƒåº¦ã€‚æœ€ååˆ†æè™šæ‹Ÿçº¿ç¨‹çš„é˜»å¡ï¼ˆä¸å¸¦è¶…æ—¶ï¼Œä¹Ÿå°±æ˜¯<code>timeout = 0</code>ï¼‰ã€é™æ—¶é˜»å¡ï¼ˆ<code>timeout &gt; 0</code>ï¼‰ã€<code>join</code>çš„å®ç°ã€‚å…ˆçœ‹ç›¸å¯¹ç®€å•çš„<code>joinNanos()</code>ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// java.lang.VirtualThread</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Thread.join() --&gt; VirtualThread.joinNanos()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è™šæ‹Ÿçº¿ç¨‹joinè°ƒç”¨</span></span>
<span class="line"><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">joinNanos</span><span style="color: #E06C75">(</span><span style="color: #C678DD">long</span><span style="color: #E06C75"> nanos) throws InterruptedException &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦‚æœçŠ¶æ€ä¸ºTERMINATEDç›´æ¥è¿”å›true</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #61AFEF">state</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> TERMINATED)</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// è·å–æ•°æ …æ å®ä¾‹</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">CountDownLatch</span><span style="color: #E06C75"> termination </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">getTermination</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å†æ¬¡éªŒè¯å¦‚æœçŠ¶æ€ä¸ºTERMINATEDç›´æ¥è¿”å›true</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #61AFEF">state</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> TERMINATED)</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å¦‚æœnanosä¸º0åˆ™è°ƒç”¨CountDownLatch.await()é˜»å¡</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (nanos </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">termination</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">await</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// å¦‚æœnanoså¤§äº0åˆ™è°ƒç”¨CountDownLatch.await(nanos,TimeUnit)é™æ—¶é˜»å¡</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> terminated </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">termination</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">await</span><span style="color: #ABB2BF">(nanos, NANOSECONDS);</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #E06C75">terminated) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// é˜»å¡åˆ°è¶…æ—¶æ—¶é™è¿‡äº†è¿”å›ï¼Œéè§£é™¤é˜»å¡ä¸‹çš„æ­£å¸¸è¿”å›</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">state</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> TERMINATED</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// è§£é™¤é˜»å¡ä¸‹çš„æ­£å¸¸è¿”å›</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// æ‡’åˆ›å»ºç»ˆç»“å€’æ•°æ …æ å®ä¾‹ï¼Œè®¾ç½®èµ„æºå€¼ä¸º1ï¼Œè¿™é‡Œç”¨åˆ°CASæ˜¯è€ƒè™‘ä¹‹å‰å·²ç»åˆ›å»ºå’Œä¿å­˜åˆ°æˆå‘˜å˜é‡ï¼Œå¦‚æœå·²åˆ›å»ºåˆ™ç›´æ¥é€‰ç”¨æˆå‘˜å˜é‡çš„é‚£ä¸ªå®ä¾‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">CountDownLatch</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">getTermination</span><span style="color: #E06C75">() &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">CountDownLatch</span><span style="color: #E06C75"> termination </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">termination</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (termination </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">null</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        termination </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">CountDownLatch</span><span style="color: #E06C75">(</span><span style="color: #D19A66">1</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #E5C07B">U</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">compareAndSetReference</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">, TERMINATION, </span><span style="color: #D19A66">null</span><span style="color: #ABB2BF">, termination)</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            termination </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">termination</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> termination</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span></code></pre></div><p>æ¥ç€çœ‹è™šæ‹Ÿçº¿ç¨‹é˜»å¡å’Œé™æ—¶é˜»å¡çš„ç°å®ï¼š</p>
<div class="language-java"><button title="Copy code" class="copy"></button><span class="lang">java</span><pre class="shiki one-dark-pro" style="background-color: #1a1a1a" tabindex="0"><code><span class="line"><span style="color: #7F848E; font-style: italic">// java.lang.VirtualThread</span></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// Thread.sleep() --&gt; VirtualThread.sleepNanos()</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// ç»™å®šä¼‘çœ æ—¶é—´è®©å½“å‰è™šæ‹Ÿçº¿ç¨‹ä¼‘çœ </span></span>
<span class="line"><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">sleepNanos</span><span style="color: #E06C75">(</span><span style="color: #C678DD">long</span><span style="color: #E06C75"> nanos) throws InterruptedException &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">currentThread</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// nanoså¿…é¡»å¤§äºç­‰äº0</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (nanos </span><span style="color: #56B6C2">&gt;=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// å¦‚æœæ”¯æŒçº¿ç¨‹ä¼‘çœ äº‹ä»¶å‘å¸ƒåˆ™åœ¨ä¼‘çœ å¤„ç†å‰åå¤„ç†ä¼‘çœ äº‹ä»¶ï¼Œæœ€ç»ˆçš„ä¼‘çœ æ“ä½œè°ƒç”¨doSleepNanos()å®Œæˆ</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #E5C07B">ThreadSleepEvent</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">isTurnedOn</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #E5C07B">ThreadSleepEvent</span><span style="color: #E06C75"> event </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">ThreadSleepEvent</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #E5C07B">event</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">time</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> nanos</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #E5C07B">event</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">begin</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #61AFEF">doSleepNanos</span><span style="color: #E06C75">(nanos)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #E5C07B">event</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">commit</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">            &#125;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">doSleepNanos</span><span style="color: #E06C75">(nanos)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// è®©å½“å‰çº¿ç¨‹ä¼‘çœ ç»™å®šçš„ç¡çœ æ—¶é—´(å•ä½ä¸ºçº³ç§’)ã€‚å¦‚æœnanosä¸º0æ—¶ï¼Œçº¿ç¨‹å°†å°è¯•yield</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">doSleepNanos</span><span style="color: #E06C75">(</span><span style="color: #C678DD">long</span><span style="color: #E06C75"> nanos) throws InterruptedException &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> nanos </span><span style="color: #56B6C2">&gt;=</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å“åº”ä¸­æ–­æ¸…ç†ä¸­æ–­çŠ¶æ€ï¼ŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #61AFEF">getAndClearInterrupt</span><span style="color: #E06C75">())</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">InterruptedException</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (nanos </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// nanosä¸º0çš„æ—¶å€™ç›´æ¥è¿›è¡Œyieldæ“ä½œï¼Œå…·ä½“æ˜¯Continuation.yield()</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">tryYield</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// park for the sleep time</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> remainingNanos </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> nanos</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// ä¸´æ—¶å˜é‡è®°å½•å¼€å§‹ä¼‘çœ æ—¶é—´</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> startNanos </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">nanoTime</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">while</span><span style="color: #E06C75"> (remainingNanos </span><span style="color: #56B6C2">&gt;</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// å‰©ä½™ä¼‘çœ æ—¶é—´å¤§äº0çº³ç§’ï¼Œè¿›è¡Œparkæ“ä½œ</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #61AFEF">parkNanos</span><span style="color: #E06C75">(remainingNanos)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// å“åº”ä¸­æ–­æ¸…ç†ä¸­æ–­çŠ¶æ€ï¼ŒæŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #61AFEF">getAndClearInterrupt</span><span style="color: #E06C75">()) &#123;</span></span>
<span class="line"><span style="color: #E06C75">                    </span><span style="color: #C678DD">throw</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">InterruptedException</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">                &#125;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #7F848E; font-style: italic">// é‡æ–°è®¡ç®—å‰©ä½™ä¼‘çœ äº‹ä»¶</span></span>
<span class="line"><span style="color: #E06C75">                remainingNanos </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> nanos </span><span style="color: #56B6C2">-</span><span style="color: #E06C75"> (</span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">nanoTime</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">-</span><span style="color: #E06C75"> startNanos)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            &#125;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// parkä¼šæ¶ˆè€—parkè®¸å¯ï¼Œèµ°åˆ°è¿™é‡Œè¯´æ˜unparkäº†ï¼Œå¯ä»¥é‡æ–°è®¾ç½®è®¸å¯</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">setParkPermit</span><span style="color: #E06C75">(</span><span style="color: #D19A66">true</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// å½“å‰è™šæ‹Ÿçº¿ç¨‹parkï¼ˆé˜»å¡ï¼‰ç›´è‡³æŒ‡å®šç­‰å€™æ—¶é—´ï¼Œè¿›è¡Œunparkæ“ä½œæˆ–è€…ä¸­æ–­ä¹Ÿèƒ½è§£é™¤parkçŠ¶æ€</span></span>
<span class="line"><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">Override</span></span>
<span class="line"><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">parkNanos</span><span style="color: #E06C75">(</span><span style="color: #C678DD">long</span><span style="color: #E06C75"> nanos) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">currentThread</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å·²ç»æ¶ˆè€—äº†parkè®¸å¯æˆ–è€…å¤„äºä¸­æ–­çŠ¶æ€ï¼Œç›´æ¥è¿”å›</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #61AFEF">getAndSetParkPermit</span><span style="color: #E06C75">(</span><span style="color: #D19A66">false</span><span style="color: #E06C75">) </span><span style="color: #56B6C2">||</span><span style="color: #E06C75"> interrupted)</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">return</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// å½“å‰è™šæ‹Ÿçº¿ç¨‹parkï¼ˆé˜»å¡ï¼‰ç›´è‡³æŒ‡å®šç­‰å€™æ—¶é—´</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (nanos </span><span style="color: #56B6C2">&gt;</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// è®°å½•å¼€å§‹parkçš„æ—¶é—´</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> startTime </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">nanoTime</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// è®°å½•æ˜¯å¦yieldæˆåŠŸ</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> yielded</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// é€šè¿‡è°ƒåº¦çº¿ç¨‹æ± æäº¤ä¸€ä¸ªå»¶æ—¶æ‰§è¡Œçš„unparkä»»åŠ¡ï¼Œç”¨äºè¿›è¡Œunparkæ“ä½œè§£é™¤å½“å‰è™šæ‹Ÿçº¿ç¨‹é˜»å¡ç­‰å¾…</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">Future</span><span style="color: #ABB2BF">&lt;</span><span style="color: #C678DD">?</span><span style="color: #ABB2BF">&gt;</span><span style="color: #E06C75"> unparker </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">scheduleUnpark</span><span style="color: #E06C75">(nanos)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// è®¾ç½®ä¸ºPARKINGçŠ¶æ€</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">setState</span><span style="color: #E06C75">(PARKING)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// æ‰§è¡ŒContinuation.yield()</span></span>
<span class="line"><span style="color: #E06C75">            yielded </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">yieldContinuation</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> (</span><span style="color: #E5C07B">Thread</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">currentThread</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75"> </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #E06C75">)</span></span>
<span class="line"><span style="color: #E06C75">                    </span><span style="color: #56B6C2">&amp;&amp;</span><span style="color: #E06C75"> (</span><span style="color: #61AFEF">state</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> RUNNING </span><span style="color: #56B6C2">||</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">state</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> PARKING)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #7F848E; font-style: italic">// æ‰§è¡ŒContinuation.yield()æ‰§è¡Œå®Œæ¯•åï¼Œå¦‚æœè¯¥unparkerä»»åŠ¡æœªå®Œæˆåˆ™è¿›è¡Œå–æ¶ˆæ“ä½œ</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">cancel</span><span style="color: #E06C75">(unparker)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// Continuation.yield()è°ƒç”¨å¤±è´¥ï¼Œåˆ™é‡æ–°è®¡ç®—ç­‰å¾…æ—¶é—´å¹¶åŸºäºè¿è½½çº¿ç¨‹è¿›è¡Œparkæ“ä½œ</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #E06C75">yielded) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> deadline </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> startTime </span><span style="color: #56B6C2">+</span><span style="color: #E06C75"> nanos</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (deadline </span><span style="color: #56B6C2">&lt;</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0L</span><span style="color: #E06C75">)</span></span>
<span class="line"><span style="color: #E06C75">                deadline </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Long</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">MAX_VALUE</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #61AFEF">parkOnCarrierThread</span><span style="color: #E06C75">(</span><span style="color: #D19A66">true</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> deadline </span><span style="color: #56B6C2">-</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">System</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">nanoTime</span><span style="color: #ABB2BF">()</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// å½“å‰è™šæ‹Ÿçº¿ç¨‹çš„è¿è½½çº¿ç¨‹parkï¼ˆé˜»å¡ï¼‰ç›´è‡³æŒ‡å®šç­‰å€™æ—¶é—´ï¼Œè¿™å°±æ˜¯å‰é¢æåˆ°è¿‡çš„pinned threadäº§ç”Ÿçš„è¿‡ç¨‹</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">parkOnCarrierThread</span><span style="color: #E06C75">(</span><span style="color: #C678DD">boolean</span><span style="color: #E06C75"> timed</span><span style="color: #ABB2BF">,</span><span style="color: #E06C75"> </span><span style="color: #C678DD">long</span><span style="color: #E06C75"> nanos) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">assert</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">state</span><span style="color: #E06C75">() </span><span style="color: #56B6C2">==</span><span style="color: #E06C75"> PARKING</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">var</span><span style="color: #E06C75"> pinnedEvent </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #C678DD">new</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">VirtualThreadPinnedEvent</span><span style="color: #E06C75">()</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">pinnedEvent</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">begin</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// è®¾ç½®çŠ¶æ€ä¸ºPINNED</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #61AFEF">setState</span><span style="color: #E06C75">(PINNED)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// å¦‚æœæ²¡æœ‰parkè®¸å¯ï¼Œåˆ™ä¸å¤„ç†ï¼Œå¦åˆ™ä½¿ç”¨Usafeçš„park apiè¿›è¡Œå¹³å°çº¿ç¨‹é˜»å¡</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #E06C75">parkPermit) &#123;</span></span>
<span class="line"><span style="color: #E06C75">            </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #E06C75">timed) &#123;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #E5C07B">U</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">park</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">, </span><span style="color: #D19A66">0</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">            &#125; </span><span style="color: #C678DD">else</span><span style="color: #E06C75"> </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (nanos </span><span style="color: #56B6C2">&gt;</span><span style="color: #E06C75"> </span><span style="color: #D19A66">0</span><span style="color: #E06C75">) &#123;</span></span>
<span class="line"><span style="color: #E06C75">                </span><span style="color: #E5C07B">U</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">park</span><span style="color: #ABB2BF">(</span><span style="color: #D19A66">false</span><span style="color: #ABB2BF">, nanos);</span></span>
<span class="line"><span style="color: #E06C75">            &#125;</span></span>
<span class="line"><span style="color: #E06C75">        &#125;</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #7F848E; font-style: italic">// é˜»å¡è§£é™¤åçŠ¶æ€ä¸ºRUNNING</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #61AFEF">setState</span><span style="color: #E06C75">(RUNNING)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// è§£é™¤é˜»å¡åæ­¤parkæ“ä½œæ¶ˆè€—äº†parkè®¸å¯</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #61AFEF">setParkPermit</span><span style="color: #E06C75">(</span><span style="color: #D19A66">false</span><span style="color: #E06C75">)</span><span style="color: #ABB2BF">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">pinnedEvent</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">commit</span><span style="color: #ABB2BF">();</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">ChangesCurrentThread</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">Future</span><span style="color: #56B6C2">&lt;</span><span style="color: #C678DD">?</span><span style="color: #56B6C2">&gt;</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">scheduleUnpark</span><span style="color: #E06C75">(</span><span style="color: #C678DD">long</span><span style="color: #E06C75"> nanos) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">Thread</span><span style="color: #E06C75"> carrier </span><span style="color: #56B6C2">=</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">.</span><span style="color: #E5C07B">carrierThread</span><span style="color: #ABB2BF">;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #7F848E; font-style: italic">// need to switch to current platform thread to avoid nested parking</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #E5C07B">carrier</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">setCurrentThread</span><span style="color: #ABB2BF">(carrier);</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">try</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #C678DD">return</span><span style="color: #E06C75"> </span><span style="color: #E5C07B">UNPARKER</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">schedule</span><span style="color: #ABB2BF">(() </span><span style="color: #C678DD">-&gt;</span><span style="color: #ABB2BF"> </span><span style="color: #61AFEF">unpark</span><span style="color: #ABB2BF">(), nanos, NANOSECONDS);</span></span>
<span class="line"><span style="color: #E06C75">    &#125; </span><span style="color: #C678DD">finally</span><span style="color: #E06C75"> &#123;</span></span>
<span class="line"><span style="color: #E06C75">        </span><span style="color: #E5C07B">carrier</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">setCurrentThread</span><span style="color: #ABB2BF">(</span><span style="color: #E5C07B">this</span><span style="color: #ABB2BF">);</span></span>
<span class="line"><span style="color: #E06C75">    &#125;</span></span>
<span class="line"><span style="color: #E06C75">&#125;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #7F848E; font-style: italic">// å¦‚æœunparkä»»åŠ¡æœªå®Œæˆåˆ™å–æ¶ˆå®ƒï¼Œè¿™ä¸ªè¿‡ç¨‹éœ€è¦åˆ‡æ¢åˆ°å½“å‰å¹³å°çº¿ç¨‹ä»¥é¿å…åµŒå¥—parkæ“ä½œ</span></span>
<span class="line"><span style="color: #ABB2BF">@</span><span style="color: #E5C07B">ChangesCurrentThread</span></span>
<span class="line"><span style="color: #C678DD">private</span><span style="color: #E06C75"> </span><span style="color: #C678DD">void</span><span style="color: #E06C75"> </span><span style="color: #61AFEF">cancel</span><span style="color: #E06C75">(</span><span style="color: #E5C07B">Future</span><span style="color: #56B6C2">&lt;</span><span style="color: #C678DD">?</span><span style="color: #56B6C2">&gt;</span><span style="color: #E06C75"> future) &#123;</span></span>
<span class="line"><span style="color: #E06C75">    </span><span style="color: #C678DD">if</span><span style="color: #E06C75"> (</span><span style="color: #56B6C2">!</span><span style="color: #E5C07B">future</span><span style="color: #ABB2BF">.</span><span style="color: #61AFEF">isDone</sp',
        1, 0, 0, '2023-12-31 00:44:57.000000', '2023-12-31 00:45:00.000000', null, null, 0, 1718181725051314178, 1, 1);
